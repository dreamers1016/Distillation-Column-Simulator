<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distillation Column — CFB2032</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            /* ── Warm cream palette ── */
            --bg:       #f4efe6;
            --bg-deep:  #ede7da;
            --surface:  rgba(255,255,255,0.75);
            --text:     #1c1917;          /* near-black, warm-tinted            */
            --text2:    #6b6560;          /* warm medium gray                   */
            --text3:    rgba(0,0,0,0.28); /* faint                              */
            --border:   rgba(0,0,0,0.07);
            --border2:  rgba(0,0,0,0.13);
            /* ── Accent colours (darker/richer for light bg) ── */
            --blue:     #0071e3;
            --green:    #1a8038;
            --orange:   #bf4200;
            --red:      #c0392b;
            --purple:   #6e2fa8;
            --teal:     #0e7a5a;
            --amber:    #7d5200;
        }

        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        /* ══ APP SHELL ══════════════════════════════════════════════════════ */
        #app {
            position: relative;
            height: 100vh; width: 100vw;
            overflow: hidden;
            background:
                radial-gradient(ellipse 110% 65% at 58% 28%,
                    rgba(0,113,227,0.055) 0%, transparent 62%),
                radial-gradient(ellipse 55% 45% at 16% 78%,
                    rgba(191,66,0,0.04) 0%, transparent 58%),
                radial-gradient(ellipse 70% 55% at 88% 60%,
                    rgba(110,47,168,0.03) 0%, transparent 55%),
                #f4efe6;
            opacity: 0;
        }

        /* ══ HEADER ══════════════════════════════════════════════════════ */
        .header {
            position: absolute;
            top: 0; left: 0; right: 0; z-index: 30;
            height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 2.5rem;
            background: rgba(244,239,230,0.82);
            backdrop-filter: blur(40px) saturate(160%);
            -webkit-backdrop-filter: blur(40px) saturate(160%);
            border-bottom: 1px solid var(--border);
        }

        .title-group { display: flex; align-items: baseline; gap: 0.9rem; }

        h1.main-title {
            font-weight: 700;
            font-size: 1.65rem;
            letter-spacing: -0.025em;
            color: var(--text);
            white-space: nowrap;
            will-change: transform, opacity;
        }

        /* .course-tag removed */

        .header-right { display: flex; align-items: center; gap: 0.7rem; }

        /* Apple-style select (light) */
        .mixture-select {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            font-weight: 500;
            background: rgba(0,0,0,0.05);
            border: 1px solid var(--border2);
            border-radius: 10px;
            color: var(--text);
            padding: 0.42rem 2rem 0.42rem 0.75rem;
            cursor: pointer;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(0,0,0,0.4)'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            min-width: 175px;
            transition: border-color 0.18s, background 0.18s;
        }
        .mixture-select:hover { background-color: rgba(0,0,0,0.09); border-color: var(--border2); }
        .mixture-select option { background: #fff; color: #1c1917; }

        /* Apple pill buttons (work on light bg) */
        .btn {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem; font-weight: 600;
            letter-spacing: -0.01em;
            border: none; padding: 0.44rem 1.1rem;
            border-radius: 980px;
            cursor: pointer;
            transition: filter 0.15s, transform 0.1s;
            white-space: nowrap;
            will-change: opacity, transform;
        }
        .btn:active { transform: scale(0.96); }

        .btn-primary {
            background: linear-gradient(180deg, #1c88f5 0%, #0068d6 100%);
            color: #fff;
            box-shadow:
                0 1px 0 rgba(255,255,255,0.26) inset,
                0 0 0 1px rgba(0,0,0,0.14),
                0 2px 6px rgba(0,113,227,0.30);
        }
        .btn-primary:hover { filter: brightness(1.08); }
        .btn-primary.active {
            background: linear-gradient(180deg, #e85e2a 0%, #b83800 100%);
            box-shadow:
                0 1px 0 rgba(255,255,255,0.2) inset,
                0 0 0 1px rgba(0,0,0,0.14),
                0 2px 6px rgba(191,66,0,0.35);
        }

        .btn-ghost {
            background: rgba(0,0,0,0.06);
            color: var(--text);
            border: 1px solid var(--border2);
        }
        .btn-ghost:hover { background: rgba(0,0,0,0.11); }

        /* Header meta info */
        .mix-meta {
            font-family: 'Space Mono', monospace;
            font-size: 1.3rem;
            color: var(--text);
            letter-spacing: 0.03em;
        }
        .mix-meta .dot { color: var(--text3); margin: 0 0.3em; }

        #error-area .err-tag {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            color: var(--red);
            background: rgba(192,57,43,0.09);
            border: 1px solid rgba(192,57,43,0.22);
            border-radius: 6px;
            padding: 0.22rem 0.55rem;
        }

        /* ══ DIAGRAM (fills full viewport) ═══════════════════════════════ */
        .diagram-area {
            position: absolute;
            inset: 0; z-index: 1;
            display: flex; align-items: center; justify-content: center;
        }

        #svg-container {
            width: 100%; height: 100%;
            /* top: clear header (70px)   bottom: clear results (110px) + copyright (54px) */
            padding: 78px 2.5rem 170px;
            display: flex; align-items: center; justify-content: center;
        }

        #svg-container svg {
            height: 100%; width: auto;
            max-height: calc(100vh - 248px);   /* 70 header + 110 results + 54 copyright + 14 gaps */
            display: block; overflow: visible;
        }

        /* SVG hover rings */
        .comp-g { cursor: pointer; }
        .comp-g .hl { opacity: 0; transition: opacity 0.18s; pointer-events: none; }
        .comp-g:hover .hl { opacity: 1; }

        /* ══ RESULTS BAR (glass panel, above copyright) ═══════════════════ */
        .results-bar {
            position: absolute;
            bottom: 54px; left: 0; right: 0; z-index: 20;
            height: 110px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            padding: 0.6rem 2.5rem 0.5rem;
            background: rgba(244,239,230,0.84);
            backdrop-filter: blur(40px) saturate(160%);
            -webkit-backdrop-filter: blur(40px) saturate(160%);
            border-top: 1px solid var(--border);
        }

        .result-item {
            padding-right: 0.8rem;
            border-right: 1px solid rgba(0,0,0,0.06);
        }
        .result-item:last-child { border-right: none; }

        .result-lbl {
            font-family: 'Space Mono', monospace;
            font-size: 1.15rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text);
            margin-bottom: 0.08rem;
        }
        .result-val {
            font-family: 'Space Mono', monospace;
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
            letter-spacing: -0.02em;
        }
        .result-sub {
            font-family: 'Space Mono', monospace;
            font-size: 1.1rem;
            color: var(--text2);
            margin-top: 0.05rem;
            letter-spacing: 0.03em;
        }

        /* ══ COPYRIGHT WATERMARK ═════════════════════════════════════════ */
        .copyright {
            position: absolute;
            bottom: 0; left: 0; right: 0; z-index: 20;
            height: 54px;
            display: flex; align-items: center; justify-content: center;
            gap: 1.25rem;
            font-family: 'Space Mono', monospace;
            font-size: 1.15rem;
            letter-spacing: 0.07em;
            text-transform: uppercase;
            color: var(--text3);
            background: rgba(237,231,218,0.75);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
        }
        .copyright span.sep { opacity: 0.4; }

        /* ══ PARAMS PANEL (right drawer) ══════════════════════════════════ */
        .params-panel {
            position: fixed;
            top: 0; right: 0; width: 520px; height: 100vh;
            z-index: 200;
            background: rgba(248,244,238,0.95);
            backdrop-filter: blur(50px) saturate(180%);
            -webkit-backdrop-filter: blur(50px) saturate(180%);
            border-left: 1px solid var(--border);
            padding: 80px 1.5rem 2rem;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
            box-shadow: -8px 0 30px rgba(0,0,0,0.06);
        }
        .params-panel.open { transform: translateX(0); }

        .panel-close {
            position: absolute; top: 1.1rem; left: 1.1rem;
            background: rgba(0,0,0,0.06);
            border: 1px solid var(--border2);
            border-radius: 980px;
            padding: 0.25rem 0.75rem;
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem; font-weight: 500;
            color: var(--text2);
            cursor: pointer; transition: background 0.15s;
        }
        .panel-close:hover { background: rgba(0,0,0,0.12); color: var(--text); }

        .panel-section-title {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text2);
            margin: 1rem 0 0.6rem;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border);
        }
        .panel-section-title:first-of-type { margin-top: 0; }

        .param-row { margin-bottom: 1rem; }
        .param-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.38rem; }
        .param-label {
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem; font-weight: 500;
            color: var(--text2);
            display: flex; align-items: center; gap: 0.35rem;
        }
        .param-val {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem; font-weight: 700;
            color: var(--text);
        }

        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 2px;
            background: rgba(0,0,0,0.14);
            border-radius: 2px; outline: none; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px; height: 14px;
            background: var(--blue);
            border-radius: 50%;
            border: 2.5px solid rgba(255,255,255,0.9);
            box-shadow: 0 0 0 1px rgba(0,113,227,0.3), 0 2px 4px rgba(0,0,0,0.15);
            cursor: pointer;
        }

        .info-btn {
            background: rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.13);
            border-radius: 50%;
            width: 40px; height: 40px;
            font-size: 1.5rem;
            font-family: 'Space Mono', monospace;
            color: var(--text2);
            cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0; flex-shrink: 0;
            transition: background 0.15s;
        }
        .info-btn:hover { background: var(--blue); color: #fff; border-color: var(--blue); }

        .error-note {
            font-family: 'Space Mono', monospace;
            font-size: 1.5rem;
            color: var(--red);
            background: rgba(192,57,43,0.07);
            border: 1px solid rgba(192,57,43,0.2);
            border-radius: 8px;
            padding: 0.4rem 0.6rem; margin-bottom: 0.75rem;
        }

        /* ══ MODALS ══════════════════════════════════════════════════════ */
        .modal-backdrop {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center; padding: 2rem;
            background: rgba(28,25,23,0.35);
            backdrop-filter: blur(24px);
        }
        .modal-box {
            background: #fff;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 18px;
            padding: 2rem;
            max-width: 720px; width: 100%;
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 32px 64px rgba(0,0,0,0.14), 0 0 0 1px rgba(0,0,0,0.06);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; }
        .modal-title { font-weight: 700; font-size: 2rem; letter-spacing: -0.02em; color: var(--text); }
        .modal-tag {
            font-family: 'Space Mono', monospace; font-size: 1.5rem;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text2); margin-top: 0.25rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .modal-tag::before { content: ''; display: inline-block; width: 18px; height: 2px; background: var(--tag-clr, var(--blue)); border-radius: 1px; }
        .modal-close {
            background: rgba(0,0,0,0.06); color: var(--text2); border: none;
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
            font-size: 0.9rem; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: background 0.15s;
        }
        .modal-close:hover { background: rgba(192,57,43,0.12); color: var(--red); }
        .modal-sec-lbl {
            font-family: 'Space Mono', monospace; font-size: 1.6rem;
            text-transform: uppercase; letter-spacing: 0.1em; color: var(--text2);
            margin-top: 1.25rem; margin-bottom: 0.5rem;
        }
        .modal-text { font-size: 1.5rem; line-height: 1.65; color: #3a3530; }
        .eq-box {
            background: rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.08);
            border-radius: 10px; padding: 0.65rem 1rem; margin-bottom: 0.4rem;
        }
        .eq-box .katex { color: var(--text); }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-top: 0.4rem; }
        .data-cell {
            background: rgba(0,0,0,0.025); border: 1px solid rgba(0,0,0,0.07);
            border-radius: 10px; padding: 0.5rem 0.75rem;
        }
        .data-cell-k { font-family: 'Space Mono', monospace; font-size: 1.5rem; text-transform: uppercase; color: var(--text2); }
        .data-cell-v { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .got-it {
            font-family: 'Inter', sans-serif; font-size: 1.5rem; font-weight: 600;
            background: linear-gradient(180deg, #1c88f5, #0068d6);
            color: #fff; border: none; padding: 0.65rem; cursor: pointer;
            border-radius: 12px; margin-top: 1.5rem; width: 100%;
            transition: filter 0.15s;
        }
        .got-it:hover { filter: brightness(1.08); }
    </style>
</head>
<body>
<div id="app">

    <!-- ── HEADER ── -->
    <div class="header">
        <div class="title-group">
            <h1 class="main-title" id="main-title">Distillation Column</h1>
        </div>
        <div class="header-right">
            <span class="mix-meta" id="mix-meta"></span>
            <div id="error-area"></div>
            <select class="mixture-select" id="mixture-select" onchange="changeMixture(this.value)"></select>
            <button class="btn btn-ghost" id="btn-params" onclick="toggleParams()">Parameters</button>
            <button class="btn btn-primary" id="btn-flow" onclick="toggleFlow()">Start Flow</button>
        </div>
    </div>

    <!-- ── FULL-SCREEN DIAGRAM ── -->
    <div class="diagram-area">
        <div id="svg-container"></div>
    </div>

    <!-- ── RESULTS BAR ── -->
    <div class="results-bar" id="results-bar"></div>

    <!-- ── COPYRIGHT WATERMARK ── -->
    <div class="copyright">
        <span>© Dr Chai Yee Ho</span>
        <span class="sep">·</span>
        <span>Department of Chemical Engineering, Universiti Teknologi PETRONAS</span>
    </div>

</div>

<!-- ── PARAMS PANEL ── -->
<div class="params-panel" id="params-panel">
    <button class="panel-close" onclick="toggleParams()">✕ Close</button>
    <div id="panel-content"></div>
</div>
<div id="modal-container"></div>

<script type="module">
import { animate, createTimeline, stagger, createMotionPath, spring } from 'https://cdn.jsdelivr.net/npm/animejs/+esm';

// ── Expose to global scope for inline handlers ─────────────────────────────
window.toggleFlow     = toggleFlow;
window.toggleParams   = toggleParams;
window.changeMixture  = changeMixture;
window.updateParam    = updateParam;
window.selectComp     = selectComp;
window.closeModal     = closeModal;
window.showParamInfo  = showParamInfo;
window.closeParamModal = () => closeModalAnimated();

// ── STATE ──────────────────────────────────────────────────────────────────
const state = {
    mix:'methanol-water', showFlow:false, showParams:false,
    selectedComp:null, showParamInfo:null,
    flowAnims:[], pulseAnims:[], prevVals:{},
    params:{
        feedTemp:75, feedPressure:1.0, feedFlow:1000, refluxRatio:2.5,
        feedComposition:0.5, distillateComposition:0.95, bottomsComposition:0.05,
        cwTempIn:25, cwTempOut:40, steamTemp:200, steamPressure:5
    }
};

// ── DATA ───────────────────────────────────────────────────────────────────
const MIXES = {
    'methanol-water':    {name:'Methanol-Water',     light:'Methanol',    heavy:'Water',     alpha:3.8,  feedComp:0.5, lam:35.3, mw:25.0, cp:3.0, T:75,  P:1.0,  bpL:64.7,  bpH:100.0},
    'ethanol-water':     {name:'Ethanol-Water',       light:'Ethanol',     heavy:'Water',     alpha:2.3,  feedComp:0.1, lam:38.6, mw:30.0, cp:3.5, T:85,  P:1.0,  bpL:78.4,  bpH:100.0},
    'benzene-toluene':   {name:'Benzene-Toluene',     light:'Benzene',     heavy:'Toluene',   alpha:2.4,  feedComp:0.5, lam:30.8, mw:85.0, cp:1.8, T:95,  P:1.0,  bpL:80.1,  bpH:110.6},
    'acetone-water':     {name:'Acetone-Water',        light:'Acetone',     heavy:'Water',     alpha:5.2,  feedComp:0.3, lam:29.1, mw:35.0, cp:3.2, T:65,  P:1.0,  bpL:56.0,  bpH:100.0},
    'propane-butane':    {name:'Propane-Butane',       light:'Propane',     heavy:'Butane',    alpha:3.5,  feedComp:0.5, lam:18.8, mw:50.0, cp:2.4, T:-10, P:5.0,  bpL:-42.1, bpH:-0.5},
    'hexane-heptane':    {name:'Hexane-Heptane',       light:'Hexane',      heavy:'Heptane',   alpha:2.3,  feedComp:0.5, lam:28.9, mw:93.0, cp:2.2, T:80,  P:1.0,  bpL:68.7,  bpH:98.4},
    'isopropanol-water': {name:'Isopropanol-Water',   light:'Isopropanol', heavy:'Water',     alpha:1.8,  feedComp:0.4, lam:39.9, mw:36.0, cp:3.4, T:85,  P:1.0,  bpL:82.6,  bpH:100.0},
    'methanol-ethanol':  {name:'Methanol-Ethanol',    light:'Methanol',    heavy:'Ethanol',   alpha:1.7,  feedComp:0.5, lam:35.3, mw:39.0, cp:2.6, T:70,  P:1.0,  bpL:64.7,  bpH:78.4}
};

const COMP_INFO = {
    condenser:    {name:'Condenser',           tag:'Shell & Tube HX',  clr:'#0071e3', fn:'Cools and condenses overhead vapor into liquid using cooling water. Vapor releases latent heat through cold tubes, converting to liquid distillate sent to the reflux drum.',                         eqs:['Q_c = V \\cdot \\lambda','Q_c = \\dot{m}_{cw} \\cdot C_{p,w} \\cdot \\Delta T_{cw}','Q_c = U_c \\cdot A_c \\cdot LMTD_c'],   params:{type:'Total condenser',U:'800 W/(m²·K)'}},
    coolingWater: {name:'Cooling Water System', tag:'Utility Circuit',  clr:'#1a8038', fn:'Supplies chilled water to the condenser to remove heat from condensing vapors. Sourced from cooling towers (25–30°C) and returned at 40–50°C.',                                                      eqs:['\\dot{m}_{cw} = \\frac{Q_c}{C_{p,w} \\cdot \\Delta T_{cw}}','LMTD = \\frac{\\Delta T_2 - \\Delta T_1}{\\ln(\\Delta T_2/\\Delta T_1)}'], params:{source:'Cooling tower','Cp,w':'4.18 kJ/(kg·K)','ΔT range':'10–20°C'}},
    refluxDrum:   {name:'Reflux Drum',          tag:'Accumulator',      clr:'#6e2fa8', fn:'Collects condensed liquid and splits it into the distillate product stream and the reflux returned to the top of the column to maintain liquid-vapor contact.',                                        eqs:['R = \\frac{L}{D}','V = L + D'],  params:{level:'50–70%',residence:'5–10 min'}},
    reboiler:     {name:'Reboiler',             tag:'Kettle HX',        clr:'#bf4200', fn:'Vaporises bottoms liquid using superheated steam. Steam condenses on the shell side, transferring latent heat to boil the process liquid and generate upward vapor flow.',                            eqs:['Q_r = V \\cdot \\lambda','Q_r = \\dot{m}_s \\cdot \\lambda_s','Q_r = U_r \\cdot A_r \\cdot LMTD_r'],   params:{type:'Kettle reboiler',U:'1000 W/(m²·K)'}},
    steamSystem:  {name:'Steam System',         tag:'Utility Circuit',  clr:'#7d5200', fn:'Supplies superheated steam to the reboiler. Steam condenses while transferring latent heat, then exits as condensate returned to the boiler for regeneration.',                                       eqs:['\\dot{m}_s = \\frac{Q_r}{\\lambda_s}','LMTD = \\frac{\\Delta T_2 - \\Delta T_1}{\\ln(\\Delta T_2/\\Delta T_1)}'], params:{'LP steam':'3–5 bar, 150°C','MP steam':'10–15 bar, 190°C','λ steam':'~2250 kJ/kg'}},
    feed:         {name:'Feed',                 tag:'Feed Stage',       clr:'#0e7a5a', fn:'Introduces the feed mixture at the optimal stage based on q-value (feed thermal condition). q < 0 = superheated vapor; 0 ≤ q ≤ 1 = two-phase; q > 1 = subcooled liquid.',                           eqs:['q = \\frac{H_V - H_F}{H_V - H_L}'],  params:{q:'0–1.2','Pump type':'Centrifugal'}},
    column:       {name:'Column',               tag:'Separation Vessel',clr:'#1c1917', fn:'Main separation vessel with multiple equilibrium stages. Vapor rises and contacts descending liquid on each tray, enabling repeated mass transfer until target purities are reached.',                 eqs:['N_{min} = \\frac{\\log\\left[\\frac{x_D}{x_B}\\cdot\\frac{1-x_B}{1-x_D}\\right]}{\\log(\\alpha)}'],  params:{type:'Sieve tray column','Efficiency':'60–80%'}},
    tray:         {name:'Sieve Tray',           tag:'Column Internals', clr:'#3a3530', fn:'Vapor bubbles through sieve perforations into liquid on the tray deck. Turbulence drives mass transfer. Liquid flows across and overflows the weir into the downcomer.',                              eqs:['\\eta_{Murphree} = \\frac{y_n - y_{n+1}}{y^* - y_{n+1}}'],  params:{spacing:'0.45–0.6 m','hole dia':'3–12 mm'}}
};

const PARAM_INFO = {
    feedTemp:       {title:'Feed Temperature',         def:'Temperature at which the feed mixture enters the column.',         app:'Determines thermal condition q. Feed can be subcooled liquid, saturated liquid, two-phase, saturated vapor, or superheated vapor.',          sig:'Impacts feed stage location, energy requirements, and separation efficiency.'},
    refluxRatio:    {title:'Reflux Ratio (R)',          def:'Ratio of liquid returned to column to distillate. R = L/D.',       app:'Operated at 1.2–1.5 × minimum reflux ratio for economic optimum.',                                                                         sig:'Higher R → better purity but higher energy and operating cost.'},
    feedFlow:       {title:'Feed Flow Rate',            def:'Mass flow rate of feed entering the column (kg/h).',              app:'Sets production capacity. Determines column diameter and heat exchanger area.',                                                               sig:'Directly scales all flows, duties, and equipment sizes.'},
    stages:         {title:'Theoretical Stages vs. Actual Trays', def:'N is the number of theoretical equilibrium stages — ideal contacts where vapour and liquid reach perfect thermodynamic equilibrium. No real tray achieves this ideal.', app:'Real sieve trays reach only ~70% of ideal equilibrium (Murphree efficiency η = 0.70). So physical trays needed = ⌈N / η⌉. Example: N = 7 → ⌈7 / 0.70⌉ = 10 actual trays.', sig:'Column height and capital cost depend on actual trays, not N. Higher α (relative volatility) means fewer stages for the same separation. Always divide by efficiency before ordering hardware.'},
    feedComposition:{title:'Feed Composition (xF)',    def:'Mole fraction of light component in the feed.',                    app:'Defines the separation problem with xD and xB.',                                                                                           sig:'Sets the material balance — all stream flows derive from this.'},
    distillatePurity:{title:'Distillate Purity (xD)', def:'Mole fraction of light component in overhead distillate.',         app:'Typical targets: 95–99.9% depending on product specification.',                                                                            sig:'Higher purity → exponentially more stages and reflux needed.'},
    bottomsPurity:  {title:'Bottoms Purity (xB)',       def:'Mole fraction of light component in bottoms (low = pure heavy).', app:'Defines heavy product specification.',                                                                                                     sig:'Together with xD, sets the total separation requirement.'},
    feedPressure:   {title:'Operating Pressure',        def:'Absolute pressure at which the column operates.',                 app:'Vacuum for heat-sensitive materials; elevated for cryogenic systems.',                                                                     sig:'Shifts boiling points and relative volatility α.'},
    cwTempIn:       {title:'CW Inlet Temperature',      def:'Cooling water temperature entering the condenser.',               app:'Typically 20–30°C from a cooling tower.',                                                                                                  sig:'Lower CW inlet → larger LMTD → smaller condenser area needed.'},
    cwTempOut:      {title:'CW Outlet Temperature',     def:'Cooling water temperature leaving the condenser.',                app:'Limited to 40–50°C to prevent scaling and corrosion.',                                                                                     sig:'Higher outlet → less CW flow but smaller LMTD → more area.'},
    steamTemp:      {title:'Steam Supply Temperature',  def:'Temperature of steam entering the reboiler.',                     app:'LP (150°C), MP (190°C), or HP (250°C) steam depending on bottoms boiling point.',                                                          sig:'Higher temp → larger LMTD → smaller reboiler area required.'},
    steamPressure:  {title:'Steam Supply Pressure',     def:'Pressure of steam supplied to the reboiler.',                     app:'LP (3–5 bar): cheapest. MP (10–15 bar): higher driving force.',                                                                            sig:'Sets saturation temperature → available temperature driving force.'}
};

// ── SVG GEOMETRY ──────────────────────────────────────────────────────────
const CX=480, CY_TOP=195, CW=110, CH=430, CY_BOT=625, FEED_Y=CY_TOP+CH/2;
const PERIM = {col:1080, cnd:680, reb:690, drum:500, cwS:306, cwR:306, stm:326, cnd2:318};

// ── CALCULATE ─────────────────────────────────────────────────────────────
function calc() {
    const m = MIXES[state.mix];
    const {distillateComposition:xD,bottomsComposition:xB,feedComposition:xF,feedFlow:F,refluxRatio:R} = state.params;
    if (xD<=xF||xF<=xB||xD<=xB) return {err:'Invalid: need xB < xF < xD',m};
    const D=F*(xF-xB)/(xD-xB), B=F-D, L=D*R, V=L+D;
    const Vmol=(V/m.mw)*1000, QcKJ=Vmol*m.lam, Qc=QcKJ/3600, Qr=Qc*1.08;
    const Nmin=Math.log((xD/(1-xD))*((1-xB)/xB))/Math.log(m.alpha);
    let Rmin=(1/(m.alpha-1))*((xD/xF)-m.alpha*((1-xD)/(1-xF)));
    if (Rmin < 0) Rmin = 0;  // clamp for asymmetric compositions
    if (R <= Rmin * 1.05) return { err: `R (${R}) must exceed Rmin×1.05 (${(Rmin*1.05).toFixed(2)})`, m };
    const X  = (R - Rmin) / (R + 1);
    const exp_arg = ((1 + 54.4*X) / (11 + 117.7*X)) * ((X - 1) / Math.sqrt(X));
    const Y  = 1 - Math.exp(exp_arg);
    const N  = Math.ceil((Nmin + Y) / (1 - Y));   // theoretical stages
    const Na = Math.ceil(N / 0.70);                // actual trays (70% efficiency)
    const lamMass=(m.lam/m.mw)*1000, Tb=m.bpL*xF+m.bpH*(1-xF);
    const qVal=(lamMass+m.cp*(Tb-state.params.feedTemp))/lamMass;
    const cwDT=state.params.cwTempOut-state.params.cwTempIn;
    const cwFlow=cwDT>0?(QcKJ/(4.18*cwDT)):0;
    const Tcond=m.bpL*xD+m.bpH*(1-xD);
    const dT1c=Tcond-state.params.cwTempOut, dT2c=Tcond-state.params.cwTempIn;
    const condLMTD=(dT1c>0&&dT2c>0&&Math.abs(dT1c-dT2c)>0.01)?(dT2c-dT1c)/Math.log(dT2c/dT1c):(dT1c>0?dT1c:0);
    const condArea=condLMTD>0?(Qc*1000)/(800*condLMTD):0;
    const stLam=2200-(state.params.steamPressure-1)*25;
    const stFlow=stLam>0?(Qr*3600)/stLam:0;
    const condT=100+(state.params.steamPressure-1)*7.5;
    const Treb=m.bpL*xB+m.bpH*(1-xB);
    const dT1r=condT-Treb, dT2r=state.params.steamTemp-Treb;
    const rebLMTD=(dT1r>0&&dT2r>0&&Math.abs(dT1r-dT2r)>0.01)?(dT2r-dT1r)/Math.log(dT2r/dT1r):(dT1r>0?dT1r:0);
    const rebArea=rebLMTD>0?(Qr*1000)/(1000*rebLMTD):0;
    return {
        D:D.toFixed(1),B:B.toFixed(1),L:L.toFixed(1),Qc:Qc.toFixed(0),Qr:Qr.toFixed(0),
        Nmin:Nmin.toFixed(1),N,Na,Rmin:Rmin.toFixed(2),q:qVal.toFixed(3),
        cwFlow:cwFlow.toFixed(0),cwDT:cwDT.toFixed(1),condLMTD:condLMTD.toFixed(1),condArea:condArea.toFixed(1),
        stFlow:stFlow.toFixed(0),stLam:stLam.toFixed(0),condT:condT.toFixed(0),rebLMTD:rebLMTD.toFixed(1),rebArea:rebArea.toFixed(1),
        m, err:null
    };
}

function rl(latex) {
    if (!window.katex) return latex;
    try { return katex.renderToString(latex,{throwOnError:false,displayMode:true}); } catch(e) { return latex; }
}

// ── SVG BUILDER (warm-light colour scheme) ────────────────────────────────
function buildSVG() {
    const stages=20, stH=CH/stages, res=calc();

    // Light-mode SVG palette
    const INK    = 'rgba(28,25,23,0.68)';     // equipment outlines
    const FAINT  = 'rgba(28,25,23,0.20)';     // leader lines / secondary
    const TXT    = 'rgba(28,25,23,0.82)';     // label text
    const TXT2   = 'rgba(28,25,23,0.42)';     // sub-label
    // Equipment colours (darker/richer for cream bg)
    const C_CND  = '#0071e3';   // condenser — Apple blue
    const C_REB  = '#bf4200';   // reboiler  — deep orange
    const C_DRUM = '#6e2fa8';   // reflux drum — purple
    const C_CW   = '#1a8038';   // CW — deep green
    const C_STM  = '#7d5200';   // steam — warm amber-brown
    const C_FEED = '#0e7a5a';   // feed — teal

    const trays = Array.from({length:stages},(_,i)=>{
        const y=CY_TOP+(i+1)*stH, alt=i%2===0;
        return `<g class="tray-line" style="transform-origin:${CX-CW/2}px ${y}px;opacity:0">
            <line x1="${CX-CW/2+2}" y1="${y}" x2="${CX+CW/2-2}" y2="${y}" stroke="${INK}" stroke-width="0.8" opacity="0.6"/>
            <line x1="${alt?CX+CW/2-10:CX-CW/2+10}" y1="${y}" x2="${alt?CX+CW/2:CX-CW/2}" y2="${y+stH}" stroke="${INK}" stroke-width="0.55" opacity="0.28"/>
            ${[0,1,2,3].map(j=>`<circle cx="${CX-CW/2+16+j*18}" cy="${y}" r="0.9" fill="${INK}" opacity="0.35"/>`).join('')}
        </g>`;
    }).join('');

    const cndHatch = Array.from({length:6},(_,i)=>
        `<line x1="325" y1="${88+i*12}" x2="555" y2="${88+i*12}" stroke="${C_CND}" stroke-width="0.55" opacity="0.22"/>`
    ).join('');
    const rebHatch = Array.from({length:5},(_,i)=>
        `<line x1="320" y1="${656+i*13}" x2="565" y2="${656+i*13}" stroke="${C_REB}" stroke-width="0.55" opacity="0.22"/>`
    ).join('');

    const pipes = `<g id="pipes-group" opacity="0">
        <line x1="464" y1="${CY_TOP}" x2="464" y2="175" stroke="${FAINT}" stroke-width="1.1"/>
        <path d="M 560 125 L 625 125 L 625 165" stroke="${FAINT}" stroke-width="1.1" fill="none"/>
        <path d="M 700 230 L 700 265 L ${CX+CW/2+10} 265 L ${CX+CW/2+10} ${CY_TOP+20}" stroke="${FAINT}" stroke-width="1.1" fill="none"/>
        <line x1="780" y1="183" x2="880" y2="183" stroke="${FAINT}" stroke-width="1.1"/>
        <line x1="60" y1="${FEED_Y}" x2="${CX-CW/2}" y2="${FEED_Y}" stroke="${FAINT}" stroke-width="1.1"/>
        <path d="M 190 106 L 260 106 L 260 120 L 320 120" stroke="${C_CW}" stroke-width="1" fill="none" opacity="0.38"/>
        <path d="M 320 155 L 260 155 L 260 168 L 190 168" stroke="${C_CW}" stroke-width="1" fill="none" opacity="0.38"/>
        <line x1="500" y1="${CY_BOT}" x2="500" y2="645" stroke="${FAINT}" stroke-width="1.1"/>
        <line x1="460" y1="645" x2="460" y2="${CY_BOT}" stroke="${FAINT}" stroke-width="1.1"/>
        <path d="M 700 693 L 645 693 L 645 708 L 570 708" stroke="${C_STM}" stroke-width="1" fill="none" opacity="0.38"/>
        <path d="M 570 748 L 645 748 L 645 763 L 700 763" stroke="${C_STM}" stroke-width="0.8" fill="none" opacity="0.28"/>
        <path d="M 480 735 L 480 765 L 880 765" stroke="${FAINT}" stroke-width="1.1" fill="none"/>
    </g>`;

    const motionPaths = `<g fill="none" stroke="none">
        <path id="mp-vapor"    d="M 464 ${CY_BOT} L 464 175"/>
        <path id="mp-liq-col"  d="M 496 ${CY_TOP} L 496 ${CY_BOT}"/>
        <path id="mp-cnd-drum" d="M 560 125 L 625 125 L 625 165"/>
        <path id="mp-reflux"   d="M 700 230 L 700 265 L ${CX+CW/2+10} 265 L ${CX+CW/2+10} ${CY_TOP+20}"/>
        <path id="mp-distil"   d="M 780 183 L 880 183"/>
        <path id="mp-feed"     d="M 60 ${FEED_Y} L ${CX-CW/2} ${FEED_Y}"/>
        <path id="mp-liq-down" d="M 500 ${CY_BOT} L 500 645"/>
        <path id="mp-reb-vap"  d="M 460 645 L 460 ${CY_BOT}"/>
        <path id="mp-bottoms"  d="M 480 735 L 480 765 L 880 765"/>
        <path id="mp-cw-in"    d="M 190 106 L 260 106 L 260 120 L 320 120"/>
        <path id="mp-cw-out"   d="M 320 155 L 260 155 L 260 168 L 190 168"/>
        <path id="mp-steam"    d="M 700 693 L 645 693 L 645 708 L 570 708"/>
        <path id="mp-cond"     d="M 570 748 L 645 748 L 645 763 L 700 763"/>
    </g>`;

    const P=(cls,col,r,n)=>Array.from({length:n},()=>
        `<circle class="${cls}" cx="0" cy="0" r="${r}" fill="${col}" opacity="0"/>`).join('');
    const particles=`<g id="particle-layer">
        ${P('pv', C_CND, 3.0, 4)} ${P('plc','rgba(0,113,227,0.7)',2.2,3)}
        ${P('pcd',C_CND, 2.2, 2)} ${P('prf',C_DRUM,2.2,2)}
        ${P('pdi',C_CND, 2.2, 2)} ${P('pf', C_FEED,2.4,3)}
        ${P('pld',C_CND, 2.0, 2)} ${P('prv',C_REB, 3.0,3)}
        ${P('pb', C_REB, 2.2, 2)} ${P('pci',C_CW,  2.4,2)}
        ${P('pco',C_CW,  2.4, 2)} ${P('psi',C_STM, 2.4,2)}
        ${P('pso',C_STM, 2.2, 2)}
    </g>`;

    // Subtle warm glows behind equipment (very light on cream bg)
    const glowDefs = `<defs>
        <radialGradient id="col-glow" cx="50%" cy="45%" r="50%">
            <stop offset="0%" stop-color="rgba(0,113,227,0.07)"/>
            <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
        <radialGradient id="reb-glow" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="rgba(191,66,0,0.06)"/>
            <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
        <marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
            <path d="M0,0 L6,3 L0,6 Z" fill="${INK}" opacity="0.6"/>
        </marker>
    </defs>
    <ellipse cx="${CX}" cy="${CY_TOP+CH/2}" rx="200" ry="260" fill="url(#col-glow)" opacity="0" id="glow-bg-col"/>
    <ellipse cx="${CX}" cy="700" rx="180" ry="120" fill="url(#reb-glow)" opacity="0" id="glow-bg-reb"/>`;

    // Labels with cream-compatible colours
    const LBL=(x,y,text,sub,anchor='end',subId='')=>
        `<g class="svg-label" opacity="0">
            <text x="${x}" y="${y}" font-family="'Space Mono',monospace" font-size="18"
                  fill="rgba(28,25,23,0.95)" text-anchor="${anchor}" font-weight="700" letter-spacing="0.02em">${text.toUpperCase()}</text>
            ${sub?`<text x="${x}" y="${y+30}" font-family="'Space Mono',monospace" font-size="13"
                         fill="rgba(28,25,23,0.70)" text-anchor="${anchor}" ${subId?`id="${subId}"`:''}>${sub}</text>`:''}
        </g>`;

    const labels=`<g id="labels-group">
        <line x1="825" y1="183" x2="922" y2="183" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(924,180,'distillate',`${res.err?'—':res.D} kg/h`,'start','svg-sub-distillate')}
        <line x1="780" y1="163" x2="922" y2="163" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(924,160,'reflux drum','R = '+state.params.refluxRatio,'start','svg-sub-drum')}
        <line x1="${CX+CW/2+65}" y1="${CY_TOP+80}" x2="922" y2="${CY_TOP+80}" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(924,CY_TOP+77,'column',`α = ${MIXES[state.mix].alpha}`,'start','svg-sub-column')}
        <line x1="825" y1="765" x2="922" y2="765" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(924,762,'bottoms',`${res.err?'—':res.B} kg/h`,'start','svg-sub-bottoms')}
        <line x1="815" y1="710" x2="922" y2="710" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(924,707,'steam sys',`${res.err?'—':res.stFlow} kg/h`,'start','svg-sub-steam')}
        <line x1="85" y1="106" x2="26" y2="106" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(24,103,'cooling water','')}
        <line x1="60" y1="${FEED_Y}" x2="26" y2="${FEED_Y}" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(24,FEED_Y-3,'feed',`xF = ${state.params.feedComposition}`,'end','svg-sub-feed')}
        <line x1="315" y1="695" x2="26" y2="695" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(24,692,'reboiler',`${res.err?'—':res.Qr} kW`,'end','svg-sub-reboiler')}
        <line x1="320" y1="120" x2="26" y2="120" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
        ${LBL(24,117,'condenser',`${res.err?'—':res.Qc} kW`,'end','svg-sub-condenser')}
    </g>`;

    document.getElementById('svg-container').innerHTML = `
    <svg viewBox="0 0 950 820" overflow="visible">
        ${glowDefs}

        <!-- CONDENSER -->
        <g class="comp-g" onclick="selectComp('condenser')">
            <rect class="hl" x="317" y="72" width="246" height="106" rx="4"
                  fill="rgba(0,113,227,0.05)" stroke="${C_CND}" stroke-width="2.4" opacity="0"/>
            <rect id="cnd-box" x="320" y="75" width="240" height="100" rx="2"
                  fill="rgba(0,113,227,0.025)" stroke="${C_CND}" stroke-width="1.6"
                  stroke-dasharray="${PERIM.cnd}" stroke-dashoffset="${PERIM.cnd}"/>
            ${cndHatch}
            <text id="lbl-condenser" x="438" y="133" font-family="'Space Mono',monospace" font-size="19"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" letter-spacing="0.12em" font-weight="700" opacity="0">CONDENSER</text>
            <line x1="320" y1="105" x2="288" y2="105" stroke="${C_CW}" stroke-width="1.2" opacity="0" class="nozzle"/>
            <line x1="320" y1="140" x2="288" y2="140" stroke="${C_CW}" stroke-width="1.2" opacity="0" class="nozzle"/>
            <line x1="560" y1="125" x2="626" y2="125" stroke="${C_DRUM}" stroke-width="1.2" opacity="0" class="nozzle"/>
            <line x1="360" y1="175" x2="360" y2="198" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
            <line x1="460" y1="175" x2="460" y2="198" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
        </g>

        <!-- REFLUX DRUM -->
        <g class="comp-g" onclick="selectComp('refluxDrum')">
            <rect class="hl" x="617" y="137" width="166" height="96" rx="4"
                  fill="rgba(110,47,168,0.05)" stroke="${C_DRUM}" stroke-width="2.4" opacity="0"/>
            <rect id="drum-box" x="620" y="140" width="160" height="90" rx="2"
                  fill="rgba(110,47,168,0.025)" stroke="${C_DRUM}" stroke-width="1.6"
                  stroke-dasharray="${PERIM.drum}" stroke-dashoffset="${PERIM.drum}"/>
            <rect x="621" y="196" width="158" height="33" rx="1" fill="${C_DRUM}" fill-opacity="0" id="drum-level"/>
            <line x1="621" y1="196" x2="779" y2="196" stroke="${C_DRUM}" stroke-width="0.6"
                  opacity="0" stroke-dasharray="4 3" id="drum-level-line"/>
            <text id="lbl-drum" x="700" y="193" font-family="'Space Mono',monospace" font-size="19"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" letter-spacing="0.1em" font-weight="700" opacity="0">REFLUX DRUM</text>
            <line x1="620" y1="155" x2="562" y2="155" stroke="${C_DRUM}" stroke-width="1.2" opacity="0" class="nozzle"/>
            <line x1="780" y1="183" x2="828" y2="183" stroke="${C_CND}" stroke-width="1.2" opacity="0" class="nozzle"/>
            <line x1="700" y1="230" x2="700" y2="266" stroke="${C_DRUM}" stroke-width="1.2" opacity="0" class="nozzle"/>
        </g>

        <!-- COLUMN BODY -->
        <g class="comp-g" onclick="selectComp('column')">
            <rect class="hl" x="${CX-CW/2-5}" y="${CY_TOP-5}" width="${CW+10}" height="${CH+10}"
                  fill="rgba(28,25,23,0.02)" stroke="rgba(28,25,23,0.35)" stroke-width="2" opacity="0"/>
            <rect id="col-box" x="${CX-CW/2}" y="${CY_TOP}" width="${CW}" height="${CH}"
                  fill="rgba(28,25,23,0.015)" stroke="${INK}" stroke-width="1.8"
                  stroke-dasharray="${PERIM.col}" stroke-dashoffset="${PERIM.col}"/>
            <ellipse cx="${CX}" cy="${CY_TOP}" rx="${CW/2}" ry="10"
                     fill="none" stroke="${INK}" stroke-width="1.6" opacity="0" id="col-top-ell"/>
            <ellipse cx="${CX}" cy="${CY_BOT}" rx="${CW/2}" ry="10"
                     fill="none" stroke="${INK}" stroke-width="1.6" opacity="0" id="col-bot-ell"/>
            ${trays}
            <line x1="${CX-CW/2}" y1="${FEED_Y}" x2="${CX-CW/2-24}" y2="${FEED_Y}"
                  stroke="${C_FEED}" stroke-width="1.4" opacity="0" id="feed-nozzle"/>
            <text x="${CX+CW/2+22}" y="${CY_TOP+CH/2-2}" font-family="'Space Mono',monospace"
                  font-size="14" fill="rgba(28,25,23,0.80)" text-anchor="start" opacity="0" id="lbl-stages">N = ${stages} theoretical</text>
            <text x="${CX+CW/2+22}" y="${CY_TOP+CH/2+14}" font-family="'Space Mono',monospace"
                  font-size="14" fill="rgba(28,25,23,0.80)" text-anchor="start" opacity="0" id="lbl-stages2">stages</text>
            <text x="${CX+CW/2+22}" y="${CY_TOP+CH/2+30}" font-family="'Space Mono',monospace"
                  font-size="11" fill="rgba(0,113,227,0.75)" text-anchor="start" opacity="0" id="lbl-stages3"
                  onclick="event.stopPropagation();showParamInfo('stages')"
                  style="cursor:pointer;text-decoration:underline">ⓘ what does this mean?</text>
        </g>

        <!-- REBOILER -->
        <g class="comp-g" onclick="selectComp('reboiler')">
            <rect class="hl" x="312" y="642" width="261" height="96" rx="4"
                  fill="rgba(191,66,0,0.05)" stroke="${C_REB}" stroke-width="2.4" opacity="0"/>
            <rect id="reb-box" x="315" y="645" width="255" height="90" rx="2"
                  fill="rgba(191,66,0,0.025)" stroke="${C_REB}" stroke-width="1.6"
                  stroke-dasharray="${PERIM.reb}" stroke-dashoffset="${PERIM.reb}"/>
            ${rebHatch}
            <path d="M 345 730 Q 352 720 359 730 T 373 730" fill="none" stroke="${C_REB}" stroke-width="1.1" opacity="0" class="heat-wave"/>
            <path d="M 400 730 Q 407 720 414 730 T 428 730" fill="none" stroke="${C_REB}" stroke-width="1.1" opacity="0" class="heat-wave"/>
            <path d="M 455 730 Q 462 720 469 730 T 483 730" fill="none" stroke="${C_REB}" stroke-width="1.1" opacity="0" class="heat-wave"/>
            <text id="lbl-reboiler" x="443" y="696" font-family="'Space Mono',monospace" font-size="19"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" letter-spacing="0.12em" font-weight="700" opacity="0">REBOILER</text>
            <line x1="443" y1="645" x2="443" y2="623" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
            <line x1="443" y1="735" x2="443" y2="762" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
            <line x1="570" y1="693" x2="700" y2="693" stroke="${C_STM}" stroke-width="1.2" opacity="0" class="nozzle"/>
            <line x1="700" y1="748" x2="570" y2="748" stroke="${C_STM}" stroke-width="1.0" opacity="0" class="nozzle"/>
        </g>

        <!-- CW BOXES -->
        <g class="comp-g" onclick="selectComp('coolingWater')">
            <rect id="cw-sup-box" x="85" y="82" width="105" height="48" rx="2"
                  fill="rgba(26,128,56,0.04)" stroke="${C_CW}" stroke-width="1.4"
                  stroke-dasharray="${PERIM.cwS}" stroke-dashoffset="${PERIM.cwS}"/>
            <text x="137" y="101" font-family="'Space Mono',monospace" font-size="18"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" font-weight="700" opacity="0" class="cw-lbl">CW SUPPLY</text>
            <text x="137" y="115" font-family="'Space Mono',monospace" font-size="13"
                  fill="rgba(0,0,0,0.70)" text-anchor="middle" opacity="0" id="svg-cw-in-temp" class="cw-lbl">${state.params.cwTempIn}°C</text>
            <rect id="cw-ret-box" x="85" y="147" width="105" height="48" rx="2"
                  fill="rgba(26,128,56,0.04)" stroke="${C_CW}" stroke-width="1.4"
                  stroke-dasharray="${PERIM.cwR}" stroke-dashoffset="${PERIM.cwR}"/>
            <text x="137" y="166" font-family="'Space Mono',monospace" font-size="18"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" font-weight="700" opacity="0" class="cw-lbl">CW RETURN</text>
            <text x="137" y="180" font-family="'Space Mono',monospace" font-size="13"
                  fill="rgba(0,0,0,0.70)" text-anchor="middle" opacity="0" id="svg-cw-out-temp" class="cw-lbl">${state.params.cwTempOut}°C</text>
        </g>

        <!-- STEAM BOXES -->
        <g class="comp-g" onclick="selectComp('steamSystem')">
            <rect id="stm-box" x="700" y="665" width="115" height="56" rx="2"
                  fill="rgba(125,82,0,0.04)" stroke="${C_STM}" stroke-width="1.4"
                  stroke-dasharray="${PERIM.stm}" stroke-dashoffset="${PERIM.stm}"/>
            <text x="757" y="686" font-family="'Space Mono',monospace" font-size="21"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" font-weight="700" opacity="0" class="stm-lbl">STEAM IN</text>
            <text x="757" y="703" font-family="'Space Mono',monospace" font-size="12"
                  fill="rgba(0,0,0,0.70)" text-anchor="middle" opacity="0" id="svg-stm-temp" class="stm-lbl">${state.params.steamTemp}°C · ${state.params.steamPressure} bar</text>
            <rect id="cnd-ret-box" x="700" y="720" width="115" height="56" rx="2"
                  fill="rgba(125,82,0,0.03)" stroke="${C_STM}" stroke-width="1.2"
                  stroke-dasharray="${PERIM.cnd2}" stroke-dashoffset="${PERIM.cnd2}"/>
            <text x="757" y="741" font-family="'Space Mono',monospace" font-size="21"
                  fill="rgba(0,0,0,0.85)" text-anchor="middle" font-weight="700" opacity="0" class="stm-lbl">CONDENSATE</text>
            <text x="757" y="758" font-family="'Space Mono',monospace" font-size="12"
                  fill="rgba(0,0,0,0.70)" text-anchor="middle" opacity="0" class="stm-lbl">RETURN</text>
        </g>

        <!-- FEED PUMP -->
        <g class="comp-g" onclick="selectComp('feed')" id="feed-pump-g" opacity="0">
            <circle cx="140" cy="${FEED_Y}" r="24" fill="rgba(14,122,90,0.06)" stroke="${C_FEED}" stroke-width="1.5"/>
            <path d="M 128 ${FEED_Y-13} A 14 14 0 0 1 152 ${FEED_Y+9}" fill="none" stroke="${C_FEED}" stroke-width="1.1" opacity="0.65"/>
            <text x="140" y="${FEED_Y+5}" font-family="'Space Mono',monospace" font-size="27"
                  fill="${C_FEED}" text-anchor="middle" font-weight="700">P</text>
            <line x1="60" y1="${FEED_Y}" x2="116" y2="${FEED_Y}" stroke="${C_FEED}" stroke-width="1.2" marker-end="url(#arr)"/>
            <line x1="164" y1="${FEED_Y}" x2="${CX-CW/2-24}" y2="${FEED_Y}" stroke="${C_FEED}" stroke-width="1.2" marker-end="url(#arr)"/>
        </g>

        ${pipes} ${motionPaths} ${particles} ${labels}
    </svg>`;
}

// ── BOOT SEQUENCE ─────────────────────────────────────────────────────────
function runBoot() {
    animate('#app', {opacity:[0,1], duration:500, ease:'linear'});
    animate('#main-title',  {translateX:[-40,0], opacity:[0,1], duration:800, ease:'outExpo', delay:150});
    animate('#course-tag',  {opacity:[0,1], duration:500, ease:'outExpo', delay:360});
    animate('.btn, .mixture-select', {
        opacity:[0,1], translateY:[-6,0], duration:400, ease:'outExpo', delay:stagger(70,{start:420})
    });

    const tl = createTimeline({defaults:{ease:'outExpo'}});

    tl.add('#glow-bg-col', {opacity:[0,0.85], duration:1200, ease:'inOutSine'}, 800)
      .add('#glow-bg-reb', {opacity:[0,0.75], duration:1000, ease:'inOutSine'}, 1000)

      .add('#col-box',     {strokeDashoffset:[PERIM.col,0], duration:950}, 600)
      .add('#col-top-ell', {opacity:[0,1], duration:400}, 1460)
      .add('#col-bot-ell', {opacity:[0,1], duration:400}, 1510)

      .add('.tray-line', {
          opacity:[0,1], scaleX:[0,1], duration:200,
          delay:stagger(22,{from:'first'}), ease:'outCirc'
      }, 1360)

      .add('#cnd-box',       {strokeDashoffset:[PERIM.cnd,0], duration:700}, 1800)
      .add('#lbl-condenser', {opacity:[0,1], duration:350}, 2390)

      .add('#reb-box',       {strokeDashoffset:[PERIM.reb,0], duration:700, ease:'outBounce'}, 2000)
      .add('#lbl-reboiler',  {opacity:[0,1], duration:350}, 2590)

      .add('#drum-box',        {strokeDashoffset:[PERIM.drum,0], duration:600, ease:'outBack'}, 2200)
      .add('#lbl-drum',        {opacity:[0,1], duration:350}, 2690)
      .add('#drum-level',      {fillOpacity:[0,0.06], duration:700, ease:'inOutSine'}, 2710)
      .add('#drum-level-line', {opacity:[0,1], duration:350}, 2730)

      .add(['#cw-sup-box','#cw-ret-box'], {
          strokeDashoffset:[PERIM.cwS,0], duration:500, delay:stagger(160)
      }, 2360)
      .add('.cw-lbl', {opacity:[0,1], duration:300, delay:stagger(50)}, 2800)

      .add(['#stm-box','#cnd-ret-box'], {
          strokeDashoffset:[PERIM.stm,0], duration:500, delay:stagger(160)
      }, 2460)
      .add('.stm-lbl', {opacity:[0,1], duration:300, delay:stagger(50)}, 2900)

      .add('#feed-pump-g', {opacity:[0,1], scale:[0.6,1], duration:550, ease:'outBack'}, 2700)
      .add('#feed-nozzle', {opacity:[0,1], duration:300}, 3060)

      .add('.nozzle',    {opacity:[0,1], duration:250, delay:stagger(35)}, 3060)
      .add('.heat-wave', {opacity:[0,0.9], duration:400, delay:stagger(100)}, 3160)
      .add('#pipes-group', {opacity:[0,0.9], duration:700}, 3160)
      .add(['#lbl-stages','#lbl-stages2','#lbl-stages3'], {opacity:[0,1], duration:400, delay:stagger(80)}, 3260)

      .add('.leader-line', {
          opacity:[0,0.6], scaleX:[0,1], duration:400,
          delay:stagger(55,{from:'first'}), ease:'outExpo'
      }, 3360)

      .add('.svg-label', {
          opacity:[0,1], translateY:[8,0], duration:350,
          delay:stagger(45,{from:'first'}), ease:'outBack'
      }, 3660)

      .call(()=>animateResults(true), 3900);

    setTimeout(startIdlePulse, 5000);
}

// ── IDLE PULSE ────────────────────────────────────────────────────────────
function startIdlePulse() {
    state.pulseAnims.push(
        animate('#glow-bg-col', {opacity:[0.6,1,0.6], duration:4500, loop:true, ease:'inOutSine'}),
        animate('#glow-bg-reb', {opacity:[0.5,0.95,0.5], duration:3200, loop:true, ease:'inOutSine'}),
        animate('#drum-level',  {fillOpacity:[0.04,0.11,0.04], duration:5500, loop:true, ease:'inOutSine'}),
        animate('.heat-wave',   {translateY:[0,-5,0], opacity:[0.75,1,0.75], duration:1800, delay:stagger(220), loop:true, ease:'inOutSine'}),
        animate('.tray-line',   {opacity:[0.7,1,0.7], duration:4500, delay:stagger(90,{from:'center'}), loop:true, ease:'inOutSine'})
    );
}

// ── FLOW ANIMATION ────────────────────────────────────────────────────────
function startFlow() {
    const SA=state.flowAnims;
    function fp(sel,pathId,dur,staggerMs,op=0.88) {
        try {
            SA.push(animate(sel,{...createMotionPath(pathId),opacity:[0,op,op,0],duration:dur,delay:stagger(staggerMs),loop:true,ease:'linear'}));
        } catch(e){}
    }
    fp('.pv','#mp-vapor',2000,500,0.95);   fp('.plc','#mp-liq-col',2400,800,0.75);
    fp('.pcd','#mp-cnd-drum',1000,500);    fp('.prf','#mp-reflux',1400,700);
    fp('.pdi','#mp-distil',800,400);       fp('.pf','#mp-feed',1200,400);
    fp('.pld','#mp-liq-down',600,300,0.75);fp('.prv','#mp-reb-vap',700,230,0.95);
    fp('.pb','#mp-bottoms',1400,700);      fp('.pci','#mp-cw-in',900,450);
    fp('.pco','#mp-cw-out',900,450);       fp('.psi','#mp-steam',800,400);
    fp('.pso','#mp-cond',800,400);
    SA.push(animate('#cnd-box',{strokeWidth:[1.6,2.4,1.6],duration:2200,loop:true,ease:'inOutSine'}));
    SA.push(animate('#reb-box',{strokeWidth:[1.6,2.4,1.6],duration:1700,loop:true,ease:'inOutSine'}));
    SA.push(animate('#glow-bg-col',{opacity:[0.7,1.2,0.7],duration:1800,loop:true,ease:'inOutSine'}));
    SA.push(animate('#glow-bg-reb',{opacity:[0.6,1.1,0.6],duration:1400,loop:true,ease:'inOutSine'}));
}

function stopFlow() {
    state.flowAnims.forEach(a=>{try{a.pause();}catch(e){}});
    state.flowAnims=[];
    animate('.pv,.plc,.pcd,.prf,.pdi,.pf,.pld,.prv,.pb,.pci,.pco,.psi,.pso',{opacity:0,duration:400});
    animate('#cnd-box,#reb-box',{strokeWidth:1.6,duration:400});
}

// ── RESULTS ───────────────────────────────────────────────────────────────
function animateResults(initial=false) {
    const res=calc(), bar=document.getElementById('results-bar');
    if (!bar) return;
    const items = res.err ? [] : [
        {l:'Distillate', v:parseFloat(res.D),    u:'kg/h',  sub:res.m.light+'-rich',       clr:'#0071e3'},
        {l:'Bottoms',    v:parseFloat(res.B),    u:'kg/h',  sub:res.m.heavy+'-rich',        clr:'#6e2fa8'},
        {l:'Reflux',     v:parseFloat(res.L),    u:'kg/h',  sub:'R = '+state.params.refluxRatio, clr:'#0071e3'},
        {l:'Calc. Stages',v:res.N,                u:'',dp:0,  sub:'Nmin = '+res.Nmin,          clr:'#6b6560'},
        {l:'Min Reflux', v:parseFloat(res.Rmin), u:'',      sub:'Underwood',                 clr:'#6b6560'},
        {l:'q-value',    v:parseFloat(res.q),    u:'',      sub:'Feed quality',               clr:'#1a8038'},
        {l:'Cond. Duty', v:parseFloat(res.Qc),   u:'kW',    sub:'Heat removal',               clr:'#0071e3'},
        {l:'Reb. Duty',  v:parseFloat(res.Qr),   u:'kW',    sub:'Heat input',                 clr:'#bf4200'}
    ];
    bar.innerHTML = items.map(it=>`
        <div class="result-item">
            <div class="result-lbl">${it.l}</div>
            <div class="result-val" data-target="${it.v}" data-dp="${it.dp!==undefined?it.dp:(it.u===''?3:0)}"
                 style="color:${it.clr}">—</div>
            <div class="result-sub">${it.u||it.sub}</div>
        </div>`).join('');
    bar.querySelectorAll('.result-val').forEach((el,i)=>{
        const it=items[i];
        const target=parseFloat(el.dataset.target), dp=parseInt(el.dataset.dp), c={v:0};

        // Flash scale on values that changed since last update
        if (!initial && state.prevVals[it.l] !== undefined) {
            if (Math.abs(target - state.prevVals[it.l]) > 0.001) {
                animate(el, {
                    scale:    [1, 1.18, 1],
                    duration: 480,
                    ease:     spring({stiffness:320, damping:10})
                });
            }
        }

        animate(c,{v:[0,target],duration:initial?900:500,delay:initial?stagger(65,{start:0})(i,items.length):0,
            ease:'outExpo',onUpdate:()=>{ el.textContent=c.v.toFixed(dp); }});
    });

    // Store values for next comparison
    items.forEach(it => { state.prevVals[it.l] = it.v; });
}

// ── UPDATE SVG LABELS ─────────────────────────────────────────────────────
// The SVG is built once on load. This function patches only the text nodes
// that carry dynamic values, so they stay in sync when sliders move.
function updateSVGLabels() {
    const res = calc();
    const set = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };

    // Right-side labels (flow values)
    set('svg-sub-distillate', res.err ? '—' : res.D  + ' kg/h');
    set('svg-sub-drum',       'R = ' + state.params.refluxRatio);
    set('svg-sub-column',     'α = ' + MIXES[state.mix].alpha);
    set('svg-sub-bottoms',    res.err ? '—' : res.B  + ' kg/h');
    set('svg-sub-steam',      res.err ? '—' : res.stFlow + ' kg/h');

    // Left-side labels
    set('svg-sub-feed',       'xF = ' + state.params.feedComposition);
    set('svg-sub-reboiler',   res.err ? '—' : res.Qr + ' kW');
    set('svg-sub-condenser',  res.err ? '—' : res.Qc + ' kW');

    // Column stage count (computed via Gilliland)
    set('lbl-stages',  res.err ? 'N = — theoretical'  : 'N = ' + res.N + ' theoretical');
    set('lbl-stages2', res.err ? ''                     : '→ ' + res.Na + ' trays  (η = 70%)');

    // Utility box labels
    set('svg-cw-in-temp',  state.params.cwTempIn  + '°C');
    set('svg-cw-out-temp', state.params.cwTempOut + '°C');
    set('svg-stm-temp',    state.params.steamTemp + '°C · ' + state.params.steamPressure + ' bar');
}

// ── UI ────────────────────────────────────────────────────────────────────
function buildMixtureSelect() {
    document.getElementById('mixture-select').innerHTML =
        Object.entries(MIXES).map(([k,m])=>
            `<option value="${k}" ${k===state.mix?'selected':''}>${m.name}</option>`
        ).join('');
}

function updateHeader() {
    const m=MIXES[state.mix], res=calc();
    document.getElementById('mix-meta').innerHTML =
        `${m.light}<span class="dot">·</span>${m.heavy}<span class="dot">·</span>α = ${m.alpha}`;
    document.getElementById('error-area').innerHTML = res.err
        ? `<span class="err-tag">⚠ ${res.err}</span>` : '';
}

function buildParamsPanel() {
    const mix=MIXES[state.mix], res=calc();
    const sliders=[
        {k:'feedTemp',        l:'Feed Temperature', p:'feedTemp',              min:mix.bpL-40,max:mix.bpH+40,step:1,    d:state.params.feedTemp+'°C',                               v:state.params.feedTemp},
        {k:'refluxRatio',     l:'Reflux Ratio (R)', p:'refluxRatio',           min:1,  max:10,  step:0.1,  d:state.params.refluxRatio,                                 v:state.params.refluxRatio},
        {k:'feedFlow',        l:'Feed Flow Rate',   p:'feedFlow',              min:500,max:5000,step:100,  d:state.params.feedFlow+' kg/h',                            v:state.params.feedFlow},
        {k:'feedComposition', l:'Feed Comp (xF)',   p:'feedComposition',       min:0.1,max:0.9, step:0.05, d:state.params.feedComposition,                             v:state.params.feedComposition},
        {k:'distillatePurity',l:'Distillate (xD)',  p:'distillateComposition', min:0.9,max:0.999,step:0.005,d:(state.params.distillateComposition*100).toFixed(1)+'%', v:state.params.distillateComposition},
        {k:'bottomsPurity',   l:'Bottoms (xB)',     p:'bottomsComposition',    min:0.001,max:0.10,step:0.005,d:(state.params.bottomsComposition*100).toFixed(1)+'%',  v:state.params.bottomsComposition},
        {k:'feedPressure',    l:'Pressure (atm)',   p:'feedPressure',          min:0.05,max:10, step:0.05, d:state.params.feedPressure+' atm',                         v:state.params.feedPressure}
    ];
    const util=[
        {k:'cwTempIn',     l:'CW Inlet Temp',   p:'cwTempIn',     min:15,max:35, step:1,  d:state.params.cwTempIn+'°C',       v:state.params.cwTempIn},
        {k:'cwTempOut',    l:'CW Outlet Temp',  p:'cwTempOut',    min:30,max:55, step:1,  d:state.params.cwTempOut+'°C',      v:state.params.cwTempOut},
        {k:'steamTemp',    l:'Steam Temp',      p:'steamTemp',    min:120,max:300,step:5, d:state.params.steamTemp+'°C',      v:state.params.steamTemp},
        {k:'steamPressure',l:'Steam Pressure',  p:'steamPressure',min:1, max:20, step:0.5,d:state.params.steamPressure+' bar',v:state.params.steamPressure}
    ];
    const row=s=>`<div class="param-row">
        <div class="param-top">
            <span class="param-label">${s.l}<button class="info-btn" onclick="showParamInfo('${s.k}')">i</button></span>
            <span class="param-val">${s.d}</span>
        </div>
        <input type="range" min="${s.min}" max="${s.max}" step="${s.step}" value="${s.v}"
               oninput="updateParam('${s.p}',this.value)">
    </div>`;
    document.getElementById('panel-content').innerHTML =
        `${res.err?`<div class="error-note">⚠ ${res.err}</div>`:''}
         <div class="panel-section-title">Process Parameters</div>${sliders.map(row).join('')}
         <div class="panel-section-title">Utility Systems</div>${util.map(row).join('')}`;
}

// ── MODAL CLOSE (animated) ────────────────────────────────────────────────
function closeModalAnimated() {
    const box = document.querySelector('#modal-container .modal-box');
    if (!box) { document.getElementById('modal-container').innerHTML = ''; return; }
    animate(box, {
        opacity:    [1, 0],
        translateY: [0, 20],
        scale:      [1, 0.96],
        duration:   260,
        ease:       'inBack'
    }).then(() => { document.getElementById('modal-container').innerHTML = ''; });
}

// ── MODALS ────────────────────────────────────────────────────────────────
function renderCompModal() {
    const c=COMP_INFO[state.selectedComp]; if (!c) return;
    const res=calc();
    const live=(()=>{
        if (res.err) return '';
        const map={
            coolingWater:[{l:'CW Flow',v:res.cwFlow+' kg/h'},{l:'LMTD',v:res.condLMTD+'°C'},{l:'HX Area',v:res.condArea+' m²'},{l:'ΔT Rise',v:res.cwDT+'°C'}],
            steamSystem: [{l:'Steam Flow',v:res.stFlow+' kg/h'},{l:'LMTD',v:res.rebLMTD+'°C'},{l:'HX Area',v:res.rebArea+' m²'},{l:'Condensate',v:res.condT+'°C'}],
            condenser:   [{l:'Duty',v:res.Qc+' kW'},{l:'CW Flow',v:res.cwFlow+' kg/h'},{l:'Area',v:res.condArea+' m²'},{l:'LMTD',v:res.condLMTD+'°C'}],
            reboiler:    [{l:'Duty',v:res.Qr+' kW'},{l:'Steam',v:res.stFlow+' kg/h'},{l:'Area',v:res.rebArea+' m²'},{l:'LMTD',v:res.rebLMTD+'°C'}]
        };
        const d=map[state.selectedComp]; if (!d) return '';
        return `<div class="modal-sec-lbl">Live Values</div>
            <div class="data-grid">${d.map(x=>`<div class="data-cell"><div class="data-cell-k">${x.l}</div><div class="data-cell-v">${x.v}</div></div>`).join('')}</div>`;
    })();
    document.getElementById('modal-container').innerHTML=`
    <div class="modal-backdrop" onclick="closeModal(event)">
        <div class="modal-box" onclick="event.stopPropagation()" style="--tag-clr:${c.clr}">
            <div class="modal-header">
                <div>
                    <div class="modal-title" style="color:${c.clr}">${c.name}</div>
                    <div class="modal-tag">${c.tag}</div>
                </div>
                <button class="modal-close" onclick="selectComp(null)">✕</button>
            </div>
            <div class="modal-sec-lbl">Function</div><p class="modal-text">${c.fn}</p>
            <div class="modal-sec-lbl">Key Equations</div>${c.eqs.map(eq=>`<div class="eq-box">${rl(eq)}</div>`).join('')}
            <div class="modal-sec-lbl">Design Parameters</div>
            <div class="data-grid">${Object.entries(c.params).map(([k,v])=>`<div class="data-cell"><div class="data-cell-k">${k}</div><div class="data-cell-v">${v}</div></div>`).join('')}</div>
            ${live}
        </div>
    </div>`;
    animate(document.querySelector('.modal-box'),{opacity:[0,1],translateY:[20,0],scale:[0.96,1],duration:360,ease:'outBack'});
}

function renderParamModal() {
    const info=PARAM_INFO[state.showParamInfo]; if (!info) return;
    document.getElementById('modal-container').innerHTML=`
    <div class="modal-backdrop" onclick="state.showParamInfo=null;closeParamModal()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div><div class="modal-title">${info.title}</div><div class="modal-tag">Parameter Reference</div></div>
                <button class="modal-close" onclick="state.showParamInfo=null;closeParamModal()">✕</button>
            </div>
            <div class="modal-sec-lbl">Definition</div><p class="modal-text">${info.def}</p>
            <div class="modal-sec-lbl">Application</div><p class="modal-text">${info.app}</p>
            <div class="modal-sec-lbl">Significance</div><p class="modal-text">${info.sig}</p>
            <button class="got-it" onclick="state.showParamInfo=null;closeParamModal()">Got it</button>
        </div>
    </div>`;
    animate(document.querySelector('.modal-box'),{opacity:[0,1],translateY:[20,0],scale:[0.96,1],duration:360,ease:'outBack'});
}

// ── EVENT HANDLERS ────────────────────────────────────────────────────────
function toggleFlow() {
    state.showFlow=!state.showFlow;
    const btn=document.getElementById('btn-flow');
    // Spring bounce — compress then release
    animate(btn, { scale:[0.88, 1], duration:600, ease:spring({stiffness:280, damping:12}) });
    if (state.showFlow) { btn.textContent='Stop Flow'; btn.classList.add('active'); startFlow(); }
    else                { btn.textContent='Start Flow'; btn.classList.remove('active'); stopFlow(); }
}
function toggleParams() {
    state.showParams=!state.showParams;
    document.getElementById('params-panel').classList.toggle('open',state.showParams);
    if (state.showParams) buildParamsPanel();
}
function changeMixture(val) {
    // Fade out old meta text, swap content, fade in new
    animate('#mix-meta', { opacity:[1,0], translateY:[0,-4], duration:180, ease:'outExpo' }).then(() => {
        state.mix=val;
        const m=MIXES[val];
        state.params.feedTemp=m.T; state.params.feedPressure=m.P; state.params.feedComposition=m.feedComp;
        updateHeader();
        animate('#mix-meta', { opacity:[0,1], translateY:[4,0], duration:300, ease:'outExpo' });
        animateResults(false); updateSVGLabels();
        if (state.showParams) buildParamsPanel();
        animate('#lbl-stages',{opacity:[0.2,1],duration:400,ease:'outExpo'});
    });
}
function updateParam(param,value) {
    state.params[param]=parseFloat(value);
    updateHeader(); animateResults(false); updateSVGLabels();
    if (state.showParams) buildParamsPanel();
}
function selectComp(k) {
    state.selectedComp=k;
    if (k) renderCompModal();
    else closeModalAnimated();
}
function closeModal(e) {
    if (e.target.classList.contains('modal-backdrop')) {
        state.selectedComp=null;
        closeModalAnimated();
    }
}
function showParamInfo(p) { state.showParamInfo=p; renderParamModal(); }

// ── INIT ──────────────────────────────────────────────────────────────────
buildMixtureSelect();
buildSVG();
updateHeader();
animateResults(false);
runBoot();
</script>
</body>
</html>
