<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distillation Column — CFB2032</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=Lora:wght@400;500&family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <style>
/* ── RESET ── */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

/* ── CUSTOM PROPERTIES ── */
:root {
  /* Left panel — Ivory / Lab Notebook */
  --lp-bg:       #F5F0E8;
  --lp-bg-deep:  #EDE8DF;
  --lp-text:     #1A1612;
  --lp-text2:    #5A534C;
  --lp-text3:    rgba(26,22,18,0.30);
  --lp-border:   rgba(26,22,18,0.09);
  --lp-border2:  rgba(26,22,18,0.16);

  /* Right panel — Navy / Control Room */
  --rp-bg:       #0A1628;
  --rp-bg2:      #0F1E35;
  --rp-text:     #E8EDF5;
  --rp-text2:    #8899AA;
  --rp-border:   rgba(255,255,255,0.07);

  /* Stream accent colours — shared across both panels */
  --c-dist:   #4FA3E0;
  --c-bot:    #E08A3C;
  --c-feed:   #4EC994;
  --c-steam:  #C8A96E;
  --c-drum:   #A47FD8;
  --c-col:    #8899AA;

  /* Ink versions (darker) for left panel */
  --ink-dist:   #1B6FAE;
  --ink-bot:    #A05A14;
  --ink-feed:   #1A7A50;
  --ink-steam:  #7A5A20;
  --ink-drum:   #6040A0;
  --ink-col:    #3A4A5A;
}

html, body { height: 100%; overflow: hidden; }
body { font-family: 'Outfit', sans-serif; background: var(--rp-bg); }

#app { height: 100vh; width: 100vw; overflow: hidden; opacity: 0; }

/* ── SPLIT LAYOUT ── */
.split-layout {
  display: grid;
  grid-template-columns: 38% 62%;
  height: 100vh;
  overflow: hidden;
}

/* ── LEFT PANEL ── */
.left-panel {
  background: var(--lp-bg);
  border-right: 1px solid rgba(0,0,0,0.10);
  height: 100vh;
  overflow: hidden;
  position: relative;
}
.left-panel::before {
  content: '';
  position: absolute;
  inset: 0;
  background-image: repeating-linear-gradient(
    to bottom,
    transparent 0px,
    transparent 27px,
    rgba(26,22,18,0.04) 27px,
    rgba(26,22,18,0.04) 28px
  );
  pointer-events: none;
  z-index: 0;
}
.left-scroll {
  position: relative;
  z-index: 1;
  height: 100vh;
  overflow-y: auto;
  padding: 0 0 2rem 0;
  scrollbar-width: thin;
  scrollbar-color: rgba(26,22,18,0.15) transparent;
}

/* ── RIGHT PANEL ── */
.right-panel {
  background: var(--rp-bg);
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.right-topbar {
  height: 48px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 1.5rem;
  border-bottom: 1px solid var(--rp-border);
}
#svg-container {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  padding: 1rem 1.5rem 0.5rem;
}
#svg-container svg {
  height: 100%;
  width: auto;
  max-height: 100%;
  display: block;
  overflow: visible;
}
.results-strip {
  height: 88px;
  flex-shrink: 0;
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  align-items: center;
  padding: 0 1.5rem;
  border-top: 1px solid var(--rp-border);
  background: rgba(255,255,255,0.025);
}

/* ── MASTHEAD ── */
.lp-masthead {
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(245,240,232,0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--lp-border);
  padding: 1rem 1.5rem 0.75rem;
}
.lp-title {
  font-family: 'Crimson Pro', Georgia, serif;
  font-size: 1.9rem;
  font-weight: 700;
  color: var(--lp-text);
  letter-spacing: -0.01em;
  line-height: 1.1;
}
.lp-tagline {
  font-family: 'Lora', Georgia, serif;
  font-size: 0.82rem;
  color: var(--lp-text2);
  margin-top: 0.15rem;
  font-style: italic;
}
.lp-mix-select {
  margin-top: 0.6rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.82rem;
  color: var(--lp-text);
  background: rgba(26,22,18,0.05);
  border: 1px solid var(--lp-border2);
  border-radius: 6px;
  padding: 0.3rem 1.6rem 0.3rem 0.6rem;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(26,22,18,0.45)'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.5rem center;
  width: 100%;
}

/* ── SHARED SECTION ── */
.lp-section {
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--lp-border);
}
.lp-section-title {
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--lp-text3);
  margin-bottom: 0.75rem;
}
.lp-body {
  font-family: 'Lora', Georgia, serif;
  font-size: 0.9rem;
  line-height: 1.7;
  color: var(--lp-text2);
}

/* ── ANATOMY ── */
.anatomy-list { display: flex; flex-direction: column; gap: 0.4rem; }
.anatomy-item {
  display: flex;
  align-items: flex-start;
  gap: 0.65rem;
  padding: 0.5rem 0.6rem;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.15s;
  border: 1px solid transparent;
}
.anatomy-item:hover { background: rgba(26,22,18,0.05); }
.anatomy-item.active {
  background: rgba(26,22,18,0.06);
  border-color: var(--lp-border2);
}
.anatomy-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  margin-top: 0.28rem;
}
.anatomy-name {
  font-family: 'Outfit', sans-serif;
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--lp-text);
}
.anatomy-desc {
  font-family: 'Lora', serif;
  font-size: 0.78rem;
  color: var(--lp-text2);
  line-height: 1.5;
  margin-top: 0.1rem;
}

/* ── LIVE ANALYSIS ── */
.analysis-card {
  background: rgba(26,22,18,0.04);
  border: 1px solid var(--lp-border2);
  border-radius: 8px;
  padding: 0.85rem 1rem;
}
.analysis-row {
  display: flex;
  align-items: baseline;
  gap: 0.5rem;
  padding: 0.35rem 0;
  border-bottom: 1px solid var(--lp-border);
  font-family: 'Lora', serif;
  font-size: 0.82rem;
  line-height: 1.5;
  color: var(--lp-text2);
}
.analysis-row:last-child { border-bottom: none; }
.analysis-label {
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--lp-text3);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 68px;
}
.analysis-val { color: var(--lp-text); font-weight: 500; }
.analysis-err {
  font-family: 'DM Mono', monospace;
  font-size: 0.78rem;
  color: #C0392B;
  background: rgba(192,57,43,0.07);
  border: 1px solid rgba(192,57,43,0.18);
  border-radius: 6px;
  padding: 0.5rem 0.75rem;
}

/* ── PARAMETER CONTROLS ── */
.param-group-title {
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.10em;
  color: var(--lp-text3);
  padding: 0.6rem 0 0.35rem;
  border-bottom: 1px solid var(--lp-border);
  margin-bottom: 0.5rem;
}
.param-row { margin-bottom: 0.9rem; }
.param-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.3rem;
}
.param-label {
  font-family: 'Outfit', sans-serif;
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--lp-text2);
  display: flex;
  align-items: center;
  gap: 0.3rem;
}
.param-val {
  font-family: 'DM Mono', monospace;
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--lp-text);
}
input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 2px;
  background: rgba(26,22,18,0.15);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px; height: 12px;
  background: var(--ink-dist);
  border-radius: 50%;
  border: 2px solid rgba(245,240,232,0.9);
  box-shadow: 0 0 0 1px rgba(27,111,174,0.3), 0 1px 3px rgba(0,0,0,0.12);
  cursor: pointer;
}
.info-btn {
  background: rgba(26,22,18,0.07);
  border: 1px solid var(--lp-border2);
  border-radius: 50%;
  width: 16px; height: 16px;
  font-size: 0.65rem;
  font-family: 'DM Mono', monospace;
  color: var(--lp-text2);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: background 0.12s;
}
.info-btn:hover { background: var(--ink-dist); color: #fff; border-color: var(--ink-dist); }

/* ── COMPONENT ACCORDIONS ── */
.accordion-item {
  border-bottom: 1px solid var(--lp-border);
}
.accordion-trigger {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.65rem 1.5rem;
  background: none;
  border: none;
  cursor: pointer;
  text-align: left;
  transition: background 0.12s;
}
.accordion-trigger:hover { background: rgba(26,22,18,0.04); }
.accordion-trigger.open { background: rgba(26,22,18,0.05); }
.accordion-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.accordion-name {
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--lp-text);
  flex: 1;
}
.accordion-tag {
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  color: var(--lp-text3);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}
.accordion-chevron {
  font-size: 0.75rem;
  color: var(--lp-text3);
  transition: transform 0.2s;
}
.accordion-trigger.open .accordion-chevron { transform: rotate(180deg); }
.accordion-body {
  display: none;
  padding: 0 1.5rem 1rem;
}
.accordion-body.open { display: block; }
.accordion-fn {
  font-family: 'Lora', serif;
  font-size: 0.82rem;
  line-height: 1.65;
  color: var(--lp-text2);
  margin-bottom: 0.65rem;
}
.eq-box {
  background: rgba(26,22,18,0.04);
  border: 1px solid var(--lp-border);
  border-radius: 6px;
  padding: 0.5rem 0.75rem;
  margin-bottom: 0.35rem;
  overflow-x: auto;
}
.live-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.3rem;
  margin-top: 0.6rem;
}
.live-cell {
  background: rgba(26,22,18,0.03);
  border: 1px solid var(--lp-border);
  border-radius: 5px;
  padding: 0.35rem 0.5rem;
}
.live-cell-k {
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--lp-text3);
}
.live-cell-v {
  font-family: 'DM Mono', monospace;
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--lp-text);
}

/* ── RIGHT PANEL COMPONENTS ── */
.flow-btn {
  font-family: 'Outfit', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  border: none;
  padding: 0.35rem 1rem;
  border-radius: 980px;
  cursor: pointer;
  transition: filter 0.15s, transform 0.1s;
  background: linear-gradient(180deg, #2A8AE0 0%, #1668B8 100%);
  color: #fff;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.08), 0 2px 8px rgba(79,163,224,0.25);
}
.flow-btn:active { transform: scale(0.96); }
.flow-btn.active {
  background: linear-gradient(180deg, #E07030 0%, #B84E10 100%);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.08), 0 2px 8px rgba(224,138,60,0.30);
}
.err-badge {
  font-family: 'DM Mono', monospace;
  font-size: 0.72rem;
  color: #E07070;
  background: rgba(224,112,112,0.12);
  border: 1px solid rgba(224,112,112,0.22);
  border-radius: 4px;
  padding: 0.2rem 0.5rem;
}
.result-item {
  padding-right: 0.75rem;
  border-right: 1px solid rgba(255,255,255,0.06);
}
.result-item:last-child { border-right: none; }
.result-lbl {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--rp-text2);
  margin-bottom: 0.05rem;
}
.result-val {
  font-family: 'DM Mono', monospace;
  font-size: 0.92rem;
  font-weight: 500;
  color: var(--rp-text);
  line-height: 1;
}
.result-sub {
  font-family: 'DM Mono', monospace;
  font-size: 0.65rem;
  color: rgba(136,153,170,0.7);
  margin-top: 0.05rem;
}
.left-footer {
  padding: 1rem 1.5rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--lp-text3);
}

/* ── MODAL ── */
.modal-backdrop {
  position: fixed; inset: 0; z-index: 9999;
  display: flex; align-items: center; justify-content: center; padding: 2rem;
  background: rgba(10,22,40,0.65);
  backdrop-filter: blur(16px);
}
.modal-box {
  background: var(--lp-bg);
  border: 1px solid var(--lp-border2);
  border-radius: 12px;
  padding: 1.5rem;
  max-width: 480px; width: 100%;
  max-height: 80vh; overflow-y: auto;
  box-shadow: 0 24px 48px rgba(0,0,0,0.3);
}
.modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}
.modal-close {
  background: rgba(26,22,18,0.07);
  border: 1px solid var(--lp-border2);
  border-radius: 50%;
  width: 28px; height: 28px;
  font-size: 0.75rem;
  color: var(--lp-text2);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.modal-close:hover { background: rgba(26,22,18,0.12); }
.modal-title { font-family: 'Crimson Pro', serif; font-size: 1.35rem; font-weight: 700; color: var(--lp-text); margin-bottom: 0.25rem; }
.modal-tag { font-family: 'DM Mono', monospace; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--lp-text3); margin-bottom: 1rem; }
.modal-sec-lbl { font-family: 'DM Mono', monospace; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.10em; color: var(--lp-text3); margin: 0.85rem 0 0.3rem; }
.modal-text { font-family: 'Lora', serif; font-size: 0.88rem; line-height: 1.65; color: var(--lp-text2); }
.got-it {
  font-family: 'Outfit', sans-serif; font-size: 0.88rem; font-weight: 600;
  background: linear-gradient(180deg, #2A8AE0, #1668B8);
  color: #fff; border: none; padding: 0.5rem;
  border-radius: 8px; margin-top: 1.25rem; width: 100%; cursor: pointer;
}

/* ── SVG HOVER ── */
.comp-g { cursor: pointer; }
.comp-g .hl { opacity: 0; transition: opacity 0.18s; pointer-events: none; }
.comp-g:hover .hl { opacity: 1; }
  </style>
</head>
<body>
<div id="app">
  <div class="split-layout">
    <!-- LEFT: Theory + Controls -->
    <div class="left-panel" id="left-panel">
      <div class="left-scroll">
        <div id="lp-masthead"></div>
        <div id="lp-intro"></div>
        <div id="lp-anatomy"></div>
        <div id="lp-equations"></div>
        <div id="lp-analysis"></div>
        <div id="lp-params"></div>
        <div id="lp-accordions"></div>
        <div class="left-footer">
          <span>© Dr Chai Yee Ho · UTP CFB2032</span>
        </div>
      </div>
    </div>
    <!-- RIGHT: Diagram -->
    <div class="right-panel" id="right-panel">
      <div class="right-topbar" id="right-topbar"></div>
      <div id="svg-container"></div>
      <div class="results-strip" id="results-bar"></div>
    </div>
  </div>
</div>
<div id="modal-container"></div>

<script type="module">
import { animate, createTimeline, stagger, createMotionPath, spring } from 'https://cdn.jsdelivr.net/npm/animejs/+esm';

// ── Expose to global scope for inline handlers ─────────────────────────────
window.toggleFlow      = toggleFlow;
window.changeMixture   = changeMixture;
window.updateParam     = updateParam;
window.selectComp      = selectComp;
window.showParamInfo   = showParamInfo;
window.closeParamModal = () => closeModalAnimated();
window.toggleAccordion = toggleAccordion;
window.scrollToAnatomy = scrollToAnatomy;

// ── STATE ──────────────────────────────────────────────────────────────────
const state = {
  mix:'methanol-water', showFlow:false,
  selectedComp:null, showParamInfo:null,
  flowAnims:[], pulseAnims:[], prevVals:{},
  params:{
    feedTemp:75, feedPressure:1.0, feedFlow:1000, refluxRatio:2.5,
    feedComposition:0.5, distillateComposition:0.95, bottomsComposition:0.05,
    cwTempIn:25, cwTempOut:40, steamTemp:200, steamPressure:5
  }
};

// ── DATA ───────────────────────────────────────────────────────────────────
const MIXES = {
  'methanol-water':    {name:'Methanol-Water',     light:'Methanol',    heavy:'Water',     alpha:3.8,  feedComp:0.5, lam:35.3, mw:25.0, cp:3.0, T:75,  P:1.0,  bpL:64.7,  bpH:100.0},
  'ethanol-water':     {name:'Ethanol-Water',       light:'Ethanol',     heavy:'Water',     alpha:2.3,  feedComp:0.1, lam:38.6, mw:30.0, cp:3.5, T:85,  P:1.0,  bpL:78.4,  bpH:100.0},
  'benzene-toluene':   {name:'Benzene-Toluene',     light:'Benzene',     heavy:'Toluene',   alpha:2.4,  feedComp:0.5, lam:30.8, mw:85.0, cp:1.8, T:95,  P:1.0,  bpL:80.1,  bpH:110.6},
  'acetone-water':     {name:'Acetone-Water',        light:'Acetone',     heavy:'Water',     alpha:5.2,  feedComp:0.3, lam:29.1, mw:35.0, cp:3.2, T:65,  P:1.0,  bpL:56.0,  bpH:100.0},
  'propane-butane':    {name:'Propane-Butane',       light:'Propane',     heavy:'Butane',    alpha:3.5,  feedComp:0.5, lam:18.8, mw:50.0, cp:2.4, T:-10, P:5.0,  bpL:-42.1, bpH:-0.5},
  'hexane-heptane':    {name:'Hexane-Heptane',       light:'Hexane',      heavy:'Heptane',   alpha:2.3,  feedComp:0.5, lam:28.9, mw:93.0, cp:2.2, T:80,  P:1.0,  bpL:68.7,  bpH:98.4},
  'isopropanol-water': {name:'Isopropanol-Water',   light:'Isopropanol', heavy:'Water',     alpha:1.8,  feedComp:0.4, lam:39.9, mw:36.0, cp:3.4, T:85,  P:1.0,  bpL:82.6,  bpH:100.0},
  'methanol-ethanol':  {name:'Methanol-Ethanol',    light:'Methanol',    heavy:'Ethanol',   alpha:1.7,  feedComp:0.5, lam:35.3, mw:39.0, cp:2.6, T:70,  P:1.0,  bpL:64.7,  bpH:78.4}
};

const COMP_INFO = {
  condenser:    {name:'Condenser',           tag:'Shell & Tube HX',  clr:'#0071e3', fn:'Cools and condenses overhead vapor into liquid using cooling water. Vapor releases latent heat through cold tubes, converting to liquid distillate sent to the reflux drum.',                         eqs:['Q_c = V \\cdot \\lambda','Q_c = \\dot{m}_{cw} \\cdot C_{p,w} \\cdot \\Delta T_{cw}','Q_c = U_c \\cdot A_c \\cdot LMTD_c'],   params:{type:'Total condenser',U:'800 W/(m²·K)'}},
  coolingWater: {name:'Cooling Water System', tag:'Utility Circuit',  clr:'#1a8038', fn:'Supplies chilled water to the condenser to remove heat from condensing vapors. Sourced from cooling towers (25–30°C) and returned at 40–50°C.',                                                      eqs:['\\dot{m}_{cw} = \\frac{Q_c}{C_{p,w} \\cdot \\Delta T_{cw}}','LMTD = \\frac{\\Delta T_2 - \\Delta T_1}{\\ln(\\Delta T_2/\\Delta T_1)}'], params:{source:'Cooling tower','Cp,w':'4.18 kJ/(kg·K)','ΔT range':'10–20°C'}},
  refluxDrum:   {name:'Reflux Drum',          tag:'Accumulator',      clr:'#6e2fa8', fn:'Collects condensed liquid and splits it into the distillate product stream and the reflux returned to the top of the column to maintain liquid-vapor contact.',                                        eqs:['R = \\frac{L}{D}','V = L + D'],  params:{level:'50–70%',residence:'5–10 min'}},
  reboiler:     {name:'Reboiler',             tag:'Kettle HX',        clr:'#bf4200', fn:'Vaporises bottoms liquid using superheated steam. Steam condenses on the shell side, transferring latent heat to boil the process liquid and generate upward vapor flow.',                            eqs:['Q_r = V \\cdot \\lambda','Q_r = \\dot{m}_s \\cdot \\lambda_s','Q_r = U_r \\cdot A_r \\cdot LMTD_r'],   params:{type:'Kettle reboiler',U:'1000 W/(m²·K)'}},
  steamSystem:  {name:'Steam System',         tag:'Utility Circuit',  clr:'#7d5200', fn:'Supplies superheated steam to the reboiler. Steam condenses while transferring latent heat, then exits as condensate returned to the boiler for regeneration.',                                       eqs:['\\dot{m}_s = \\frac{Q_r}{\\lambda_s}','LMTD = \\frac{\\Delta T_2 - \\Delta T_1}{\\ln(\\Delta T_2/\\Delta T_1)}'], params:{'LP steam':'3–5 bar, 150°C','MP steam':'10–15 bar, 190°C','λ steam':'~2250 kJ/kg'}},
  feed:         {name:'Feed',                 tag:'Feed Stage',       clr:'#0e7a5a', fn:'Introduces the feed mixture at the optimal stage based on q-value (feed thermal condition). q < 0 = superheated vapor; 0 ≤ q ≤ 1 = two-phase; q > 1 = subcooled liquid.',                           eqs:['q = \\frac{H_V - H_F}{H_V - H_L}'],  params:{q:'0–1.2','Pump type':'Centrifugal'}},
  column:       {name:'Column',               tag:'Separation Vessel',clr:'#1c1917', fn:'Main separation vessel with multiple equilibrium stages. Vapor rises and contacts descending liquid on each tray, enabling repeated mass transfer until target purities are reached.',                 eqs:['N_{min} = \\frac{\\log\\left[\\frac{x_D}{x_B}\\cdot\\frac{1-x_B}{1-x_D}\\right]}{\\log(\\alpha)}'],  params:{type:'Sieve tray column','Efficiency':'60–80%'}},
  tray:         {name:'Sieve Tray',           tag:'Column Internals', clr:'#3a3530', fn:'Vapor bubbles through sieve perforations into liquid on the tray deck. Turbulence drives mass transfer. Liquid flows across and overflows the weir into the downcomer.',                              eqs:['\\eta_{Murphree} = \\frac{y_n - y_{n+1}}{y^* - y_{n+1}}'],  params:{spacing:'0.45–0.6 m','hole dia':'3–12 mm'}}
};

const PARAM_INFO = {
  feedTemp:       {title:'Feed Temperature',         def:'Temperature at which the feed mixture enters the column.',         app:'Determines thermal condition q. Feed can be subcooled liquid, saturated liquid, two-phase, saturated vapor, or superheated vapor.',          sig:'Impacts feed stage location, energy requirements, and separation efficiency.'},
  refluxRatio:    {title:'Reflux Ratio (R)',          def:'Ratio of liquid returned to column to distillate. R = L/D.',       app:'Operated at 1.2–1.5 × minimum reflux ratio for economic optimum.',                                                                         sig:'Higher R → better purity but higher energy and operating cost.'},
  feedFlow:       {title:'Feed Flow Rate',            def:'Mass flow rate of feed entering the column (kg/h).',              app:'Sets production capacity. Determines column diameter and heat exchanger area.',                                                               sig:'Directly scales all flows, duties, and equipment sizes.'},
  stages:         {title:'Theoretical Stages vs. Actual Trays', def:'N is the number of theoretical equilibrium stages — ideal contacts where vapour and liquid reach perfect thermodynamic equilibrium. No real tray achieves this ideal.', app:'Real sieve trays reach only ~70% of ideal equilibrium (Murphree efficiency η = 0.70). So physical trays needed = ⌈N / η⌉. Example: N = 7 → ⌈7 / 0.70⌉ = 10 actual trays.', sig:'Column height and capital cost depend on actual trays, not N. Higher α (relative volatility) means fewer stages for the same separation. Always divide by efficiency before ordering hardware.'},
  feedComposition:{title:'Feed Composition (xF)',    def:'Mole fraction of light component in the feed.',                    app:'Defines the separation problem with xD and xB.',                                                                                           sig:'Sets the material balance — all stream flows derive from this.'},
  distillatePurity:{title:'Distillate Purity (xD)', def:'Mole fraction of light component in overhead distillate.',         app:'Typical targets: 95–99.9% depending on product specification.',                                                                            sig:'Higher purity → exponentially more stages and reflux needed.'},
  bottomsPurity:  {title:'Bottoms Purity (xB)',       def:'Mole fraction of light component in bottoms (low = pure heavy).', app:'Defines heavy product specification.',                                                                                                     sig:'Together with xD, sets the total separation requirement.'},
  feedPressure:   {title:'Operating Pressure',        def:'Absolute pressure at which the column operates.',                 app:'Vacuum for heat-sensitive materials; elevated for cryogenic systems.',                                                                     sig:'Shifts boiling points and relative volatility α.'},
  cwTempIn:       {title:'CW Inlet Temperature',      def:'Cooling water temperature entering the condenser.',               app:'Typically 20–30°C from a cooling tower.',                                                                                                  sig:'Lower CW inlet → larger LMTD → smaller condenser area needed.'},
  cwTempOut:      {title:'CW Outlet Temperature',     def:'Cooling water temperature leaving the condenser.',                app:'Limited to 40–50°C to prevent scaling and corrosion.',                                                                                     sig:'Higher outlet → less CW flow but smaller LMTD → more area.'},
  steamTemp:      {title:'Steam Supply Temperature',  def:'Temperature of steam entering the reboiler.',                     app:'LP (150°C), MP (190°C), or HP (250°C) steam depending on bottoms boiling point.',                                                          sig:'Higher temp → larger LMTD → smaller reboiler area required.'},
  steamPressure:  {title:'Steam Supply Pressure',     def:'Pressure of steam supplied to the reboiler.',                     app:'LP (3–5 bar): cheapest. MP (10–15 bar): higher driving force.',                                                                            sig:'Sets saturation temperature → available temperature driving force.'}
};

// ── SVG GEOMETRY ──────────────────────────────────────────────────────────
const CX=480, CY_TOP=195, CW=110, CH=430, CY_BOT=625, FEED_Y=CY_TOP+CH/2;
const PERIM = {col:1080, cnd:680, reb:690, drum:500, cwS:306, cwR:306, stm:326, cnd2:318};

// ── CALCULATE ─────────────────────────────────────────────────────────────
function calc() {
  const m = MIXES[state.mix];
  const {distillateComposition:xD,bottomsComposition:xB,feedComposition:xF,feedFlow:F,refluxRatio:R} = state.params;
  const lamMass=(m.lam/m.mw)*1000, Tb=m.bpL*xF+m.bpH*(1-xF);
  const qVal=(lamMass+m.cp*(Tb-state.params.feedTemp))/lamMass;
  // Real-plant: drum level control increases reflux when feed is hot/vaporous
  const qDev = Math.min(Math.max(0, 1 - qVal), 1.5); // deviation below saturated liquid
  const R_eff = R * (1 + 0.10 * qDev);               // up to ~15% implicit increase
  const Tcond = m.bpL*xD + m.bpH*(1-xD);
  const Treb  = m.bpL*xB + m.bpH*(1-xB);
  const lamCond = m.lam * (Tcond + 273.15) / (Tb + 273.15);
  const lamReb  = m.lam * (Treb  + 273.15) / (Tb + 273.15);
  if (xD<=xF||xF<=xB||xD<=xB) return {err:'Invalid: need xB < xF < xD',m};
  const D=F*(xF-xB)/(xD-xB), B=F-D, L=D*R_eff, V=L+D;
  const Fmol = (F / m.mw) * 1000;
  const Vmol = (V / m.mw) * 1000;
  // Real-plant: column temperature profile shifts with feed thermal state
  // ~10% of feed superheat (above bubble point) propagates to overhead section
  const T_overhead = Tcond + 0.10 * Math.max(0, state.params.feedTemp - Tb);
  const Cp_v = m.cp * 0.75; // vapor Cp ≈ 75% of liquid Cp (engineering estimate)
  const QcKJ = Vmol * lamCond;
  const QcSensible = Vmol * Cp_v * Math.max(0, T_overhead - Tcond) / 3600; // kW
  const Qc   = QcKJ / 3600 + QcSensible;
  const Vprime_mol = Vmol + (qVal - 1) * Fmol;
  const QrKJ = Vprime_mol * lamReb;
  const Qr   = QrKJ / 3600 * 1.08;
  const Nmin=Math.log((xD/(1-xD))*((1-xB)/xB))/Math.log(m.alpha);
  let Rmin=(1/(m.alpha-1))*((xD/xF)-m.alpha*((1-xD)/(1-xF)));
  if (Rmin < 0) Rmin = 0;
  if (R <= Rmin * 1.05) return { err: `R (${R}) must exceed Rmin×1.05 (${(Rmin*1.05).toFixed(2)})`, m };
  const rectSlope = R / (R + 1);
  const rectInt   = xD / (R + 1);
  let xFeed;
  if (Math.abs(qVal - 1) < 1e-6) {
    xFeed = xF;
  } else {
    const qSlope = qVal / (qVal - 1);
    xFeed = (xF * (1 - qSlope) - rectInt) / (rectSlope - qSlope);
  }
  xFeed = Math.max(xB + 1e-6, Math.min(xD - 1e-6, xFeed));
  const yFeed     = rectSlope * xFeed + rectInt;
  const stripSlope = (yFeed - xB) / (xFeed - xB);
  const stripInt   = xB * (1 - stripSlope);
  let y = xD;
  let N = 0;
  while (y > xB + 1e-6 && N < 200) {
    const xEq = y / (m.alpha - (m.alpha - 1) * y);
    N++;
    if (xEq <= xB + 1e-6) break;
    y = (xEq >= xFeed)
      ? rectSlope * xEq + rectInt
      : stripSlope * xEq + stripInt;
  }
  const Na = Math.ceil(N / 0.70);
  const cwDT=state.params.cwTempOut-state.params.cwTempIn;
  const cwFlow=cwDT>0?(QcKJ/(4.18*cwDT)):0;
  const dT1c=Tcond-state.params.cwTempOut, dT2c=Tcond-state.params.cwTempIn;
  const condLMTD=(dT1c>0&&dT2c>0&&Math.abs(dT1c-dT2c)>0.01)?(dT2c-dT1c)/Math.log(dT2c/dT1c):(dT1c>0?dT1c:0);
  const condArea=condLMTD>0?(Qc*1000)/(800*condLMTD):0;
  const stLam=2200-(state.params.steamPressure-1)*25;
  const stFlow=stLam>0?(Qr*3600)/stLam:0;
  const condT=100+(state.params.steamPressure-1)*7.5;
  const dT1r=condT-Treb, dT2r=state.params.steamTemp-Treb;
  const rebLMTD=(dT1r>0&&dT2r>0&&Math.abs(dT1r-dT2r)>0.01)?(dT2r-dT1r)/Math.log(dT2r/dT1r):(dT1r>0?dT1r:0);
  const rebArea=rebLMTD>0?(Qr*1000)/(1000*rebLMTD):0;
  return {
    D:D.toFixed(1),B:B.toFixed(1),L:L.toFixed(1),Qc:Qc.toFixed(0),Qr:Qr.toFixed(0),
    Nmin:Nmin.toFixed(1),N,Na,Rmin:Rmin.toFixed(2),q:qVal.toFixed(3),
    cwFlow:cwFlow.toFixed(0),cwDT:cwDT.toFixed(1),condLMTD:condLMTD.toFixed(1),condArea:condArea.toFixed(1),
    stFlow:stFlow.toFixed(0),stLam:stLam.toFixed(0),condT:condT.toFixed(0),rebLMTD:rebLMTD.toFixed(1),rebArea:rebArea.toFixed(1),
    Reff: R_eff.toFixed(2), Toverhead: T_overhead.toFixed(1), QcSensible: QcSensible.toFixed(0),
    m, err:null
  };
}

function rl(latex) {
  if (!window.katex) return latex;
  try { return katex.renderToString(latex,{throwOnError:false,displayMode:true}); } catch(e) { return latex; }
}

// ── SVG BUILDER (dark-navy colour scheme) ─────────────────────────────────
function buildSVG() {
  const stages=20, stH=CH/stages, res=calc();

  // Dark-mode SVG palette
  const INK    = 'rgba(232,237,245,0.72)';
  const FAINT  = 'rgba(232,237,245,0.18)';
  const TXT    = 'rgba(232,237,245,0.88)';
  const TXT2   = 'rgba(232,237,245,0.45)';

  // Stream accent colours — glow on dark bg
  const C_CND  = '#4FA3E0';
  const C_REB  = '#E08A3C';
  const C_DRUM = '#A47FD8';
  const C_CW   = '#4EC994';
  const C_STM  = '#C8A96E';
  const C_FEED = '#4EC994';

  const trays = Array.from({length:stages},(_,i)=>{
    const y=CY_TOP+(i+1)*stH, alt=i%2===0;
    return `<g class="tray-line" style="transform-origin:${CX-CW/2}px ${y}px;opacity:0">
      <line x1="${CX-CW/2+2}" y1="${y}" x2="${CX+CW/2-2}" y2="${y}" stroke="${INK}" stroke-width="0.8" opacity="0.6"/>
      <line x1="${alt?CX+CW/2-10:CX-CW/2+10}" y1="${y}" x2="${alt?CX+CW/2:CX-CW/2}" y2="${y+stH}" stroke="${INK}" stroke-width="0.55" opacity="0.28"/>
      ${[0,1,2,3].map(j=>`<circle cx="${CX-CW/2+16+j*18}" cy="${y}" r="0.9" fill="${INK}" opacity="0.35"/>`).join('')}
    </g>`;
  }).join('');

  const cndHatch = Array.from({length:6},(_,i)=>
    `<line x1="325" y1="${88+i*12}" x2="555" y2="${88+i*12}" stroke="${C_CND}" stroke-width="0.55" opacity="0.22"/>`
  ).join('');
  const rebHatch = Array.from({length:5},(_,i)=>
    `<line x1="320" y1="${656+i*13}" x2="565" y2="${656+i*13}" stroke="${C_REB}" stroke-width="0.55" opacity="0.22"/>`
  ).join('');

  const pipes = `<g id="pipes-group" opacity="0">
    <line x1="464" y1="${CY_TOP}" x2="464" y2="175" stroke="${FAINT}" stroke-width="1.1"/>
    <path d="M 560 125 L 625 125 L 625 165" stroke="${FAINT}" stroke-width="1.1" fill="none"/>
    <path d="M 700 230 L 700 265 L ${CX+CW/2+10} 265 L ${CX+CW/2+10} ${CY_TOP+20}" stroke="${FAINT}" stroke-width="1.1" fill="none"/>
    <line x1="780" y1="183" x2="880" y2="183" stroke="${FAINT}" stroke-width="1.1"/>
    <line x1="60" y1="${FEED_Y}" x2="${CX-CW/2}" y2="${FEED_Y}" stroke="${FAINT}" stroke-width="1.1"/>
    <path d="M 190 106 L 260 106 L 260 120 L 320 120" stroke="${C_CW}" stroke-width="1" fill="none" opacity="0.38"/>
    <path d="M 320 155 L 260 155 L 260 168 L 190 168" stroke="${C_CW}" stroke-width="1" fill="none" opacity="0.38"/>
    <line x1="500" y1="${CY_BOT}" x2="500" y2="645" stroke="${FAINT}" stroke-width="1.1"/>
    <line x1="460" y1="645" x2="460" y2="${CY_BOT}" stroke="${FAINT}" stroke-width="1.1"/>
    <path d="M 700 693 L 645 693 L 645 708 L 570 708" stroke="${C_STM}" stroke-width="1" fill="none" opacity="0.38"/>
    <path d="M 570 748 L 645 748 L 645 763 L 700 763" stroke="${C_STM}" stroke-width="0.8" fill="none" opacity="0.28"/>
    <path d="M 480 735 L 480 765 L 880 765" stroke="${FAINT}" stroke-width="1.1" fill="none"/>
  </g>`;

  const motionPaths = `<g fill="none" stroke="none">
    <path id="mp-vapor"    d="M 464 ${CY_BOT} L 464 175"/>
    <path id="mp-liq-col"  d="M 496 ${CY_TOP} L 496 ${CY_BOT}"/>
    <path id="mp-cnd-drum" d="M 560 125 L 625 125 L 625 165"/>
    <path id="mp-reflux"   d="M 700 230 L 700 265 L ${CX+CW/2+10} 265 L ${CX+CW/2+10} ${CY_TOP+20}"/>
    <path id="mp-distil"   d="M 780 183 L 880 183"/>
    <path id="mp-feed"     d="M 60 ${FEED_Y} L ${CX-CW/2} ${FEED_Y}"/>
    <path id="mp-liq-down" d="M 500 ${CY_BOT} L 500 645"/>
    <path id="mp-reb-vap"  d="M 460 645 L 460 ${CY_BOT}"/>
    <path id="mp-bottoms"  d="M 480 735 L 480 765 L 880 765"/>
    <path id="mp-cw-in"    d="M 190 106 L 260 106 L 260 120 L 320 120"/>
    <path id="mp-cw-out"   d="M 320 155 L 260 155 L 260 168 L 190 168"/>
    <path id="mp-steam"    d="M 700 693 L 645 693 L 645 708 L 570 708"/>
    <path id="mp-cond"     d="M 570 748 L 645 748 L 645 763 L 700 763"/>
  </g>`;

  const P=(cls,col,r,n)=>Array.from({length:n},()=>
    `<circle class="${cls}" cx="0" cy="0" r="${r}" fill="${col}" opacity="0"/>`).join('');
  const particles=`<g id="particle-layer">
    ${P('pv', C_CND, 3.0, 4)} ${P('plc','rgba(79,163,224,0.7)',2.2,3)}
    ${P('pcd',C_CND, 2.2, 2)} ${P('prf',C_DRUM,2.2,2)}
    ${P('pdi',C_CND, 2.2, 2)} ${P('pf', C_FEED,2.4,3)}
    ${P('pld',C_CND, 2.0, 2)} ${P('prv',C_REB, 3.0,3)}
    ${P('pb', C_REB, 2.2, 2)} ${P('pci',C_CW,  2.4,2)}
    ${P('pco',C_CW,  2.4, 2)} ${P('psi',C_STM, 2.4,2)}
    ${P('pso',C_STM, 2.2, 2)}
  </g>`;

  // Stronger glows for dark background
  const glowDefs = `<defs>
    <radialGradient id="col-glow" cx="50%" cy="45%" r="50%">
      <stop offset="0%" stop-color="rgba(79,163,224,0.18)"/>
      <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
    </radialGradient>
    <radialGradient id="reb-glow" cx="50%" cy="50%" r="50%">
      <stop offset="0%" stop-color="rgba(224,138,60,0.15)"/>
      <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
    </radialGradient>
    <filter id="glow-filter">
      <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
      <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <marker id="arr" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
      <path d="M0,0 L6,3 L0,6 Z" fill="${INK}" opacity="0.6"/>
    </marker>
  </defs>
  <ellipse cx="${CX}" cy="${CY_TOP+CH/2}" rx="200" ry="260" fill="url(#col-glow)" opacity="0" id="glow-bg-col"/>
  <ellipse cx="${CX}" cy="700" rx="180" ry="120" fill="url(#reb-glow)" opacity="0" id="glow-bg-reb"/>`;

  // Dark-theme label helper
  const LBL=(x,y,text,sub,anchor='end',subId='',subDy=30)=>
    `<g class="svg-label" opacity="0">
      <text x="${x}" y="${y}" font-family="'DM Mono',monospace" font-size="18"
            fill="rgba(232,237,245,0.92)" text-anchor="${anchor}" font-weight="500"
            letter-spacing="0.04em">${text.toUpperCase()}</text>
      ${sub?`<text x="${x}" y="${y+subDy}" font-family="'DM Mono',monospace" font-size="13"
                   fill="rgba(232,237,245,0.50)" text-anchor="${anchor}"
                   ${subId?`id="${subId}"`:''}>${sub}</text>`:''}
    </g>`;

  const labels=`<g id="labels-group">
    <line x1="780" y1="152" x2="922" y2="152" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(924,143,'reflux drum','— kg/h','start','svg-sub-drum',18)}
    <text x="924" y="179" font-family="'DM Mono',monospace" font-size="13"
          fill="rgba(232,237,245,0.50)" text-anchor="start" id="svg-sub-drum-r">R = ${state.params.refluxRatio}</text>
    <line x1="825" y1="216" x2="922" y2="216" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(924,207,'distillate',`${res.err?'—':res.D} kg/h`,'start','svg-sub-distillate',18)}
    <line x1="${CX+CW/2+65}" y1="${CY_TOP+80}" x2="922" y2="${CY_TOP+80}" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(924,CY_TOP+77,'column',`α = ${MIXES[state.mix].alpha}`,'start','svg-sub-column')}
    <line x1="825" y1="765" x2="922" y2="765" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(924,762,'bottoms',`${res.err?'—':res.B} kg/h`,'start','svg-sub-bottoms')}
    <line x1="815" y1="710" x2="922" y2="710" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(924,707,'steam sys',`${res.err?'—':res.stFlow} kg/h`,'start','svg-sub-steam')}
    <line x1="85" y1="106" x2="26" y2="106" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(24,103,'cooling water','')}
    <line x1="60" y1="${FEED_Y}" x2="26" y2="${FEED_Y}" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(24,FEED_Y-3,'feed','— kg/h','end','svg-sub-feed')}
    <text x="24" y="${FEED_Y+42}" font-family="'DM Mono',monospace" font-size="13"
          fill="rgba(232,237,245,0.50)" text-anchor="end" id="svg-sub-feed-xf">xF = ${state.params.feedComposition}</text>
    <line x1="315" y1="695" x2="26" y2="695" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(24,692,'reboiler',`${res.err?'—':res.Qr} kW`,'end','svg-sub-reboiler')}
    <line x1="320" y1="120" x2="26" y2="120" stroke="${FAINT}" stroke-width="0.65" class="leader-line" opacity="0"/>
    ${LBL(24,117,'condenser',`${res.err?'—':res.Qc} kW`,'end','svg-sub-condenser')}
  </g>`;

  return `<svg viewBox="0 0 950 820" overflow="visible">
    ${glowDefs}

    <!-- CONDENSER -->
    <g class="comp-g" onclick="selectComp('condenser')">
      <rect class="hl" x="317" y="72" width="246" height="106" rx="4"
            fill="rgba(79,163,224,0.07)" stroke="${C_CND}" stroke-width="2.4" opacity="0"/>
      <rect id="cnd-box" x="320" y="75" width="240" height="100" rx="2"
            fill="rgba(79,163,224,0.04)" stroke="${C_CND}" stroke-width="1.6"
            stroke-dasharray="${PERIM.cnd}" stroke-dashoffset="${PERIM.cnd}"/>
      ${cndHatch}
      <text id="lbl-condenser" x="438" y="133" font-family="'DM Mono',monospace" font-size="19"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" letter-spacing="0.12em" font-weight="500" opacity="0">CONDENSER</text>
      <line x1="320" y1="105" x2="288" y2="105" stroke="${C_CW}" stroke-width="1.2" opacity="0" class="nozzle"/>
      <line x1="320" y1="140" x2="288" y2="140" stroke="${C_CW}" stroke-width="1.2" opacity="0" class="nozzle"/>
      <line x1="560" y1="125" x2="626" y2="125" stroke="${C_DRUM}" stroke-width="1.2" opacity="0" class="nozzle"/>
      <line x1="360" y1="175" x2="360" y2="198" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
      <line x1="460" y1="175" x2="460" y2="198" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
    </g>

    <!-- REFLUX DRUM -->
    <g class="comp-g" onclick="selectComp('refluxDrum')">
      <rect class="hl" x="617" y="137" width="166" height="96" rx="4"
            fill="rgba(164,127,216,0.07)" stroke="${C_DRUM}" stroke-width="2.4" opacity="0"/>
      <rect id="drum-box" x="620" y="140" width="160" height="90" rx="2"
            fill="rgba(164,127,216,0.04)" stroke="${C_DRUM}" stroke-width="1.6"
            stroke-dasharray="${PERIM.drum}" stroke-dashoffset="${PERIM.drum}"/>
      <rect x="621" y="196" width="158" height="33" rx="1" fill="${C_DRUM}" fill-opacity="0" id="drum-level"/>
      <line x1="621" y1="196" x2="779" y2="196" stroke="${C_DRUM}" stroke-width="0.6"
            opacity="0" stroke-dasharray="4 3" id="drum-level-line"/>
      <text id="lbl-drum" x="700" y="193" font-family="'DM Mono',monospace" font-size="16"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" letter-spacing="0.1em" font-weight="500" opacity="0">REFLUX DRUM</text>
      <line x1="620" y1="155" x2="562" y2="155" stroke="${C_DRUM}" stroke-width="1.2" opacity="0" class="nozzle"/>
      <line x1="780" y1="183" x2="828" y2="183" stroke="${C_CND}" stroke-width="1.2" opacity="0" class="nozzle"/>
      <line x1="700" y1="230" x2="700" y2="266" stroke="${C_DRUM}" stroke-width="1.2" opacity="0" class="nozzle"/>
    </g>

    <!-- COLUMN BODY -->
    <g class="comp-g" onclick="selectComp('column')">
      <rect class="hl" x="${CX-CW/2-5}" y="${CY_TOP-5}" width="${CW+10}" height="${CH+10}"
            fill="rgba(232,237,245,0.02)" stroke="rgba(232,237,245,0.25)" stroke-width="2" opacity="0"/>
      <rect id="col-box" x="${CX-CW/2}" y="${CY_TOP}" width="${CW}" height="${CH}"
            fill="rgba(232,237,245,0.015)" stroke="${INK}" stroke-width="1.8"
            stroke-dasharray="${PERIM.col}" stroke-dashoffset="${PERIM.col}"/>
      <ellipse cx="${CX}" cy="${CY_TOP}" rx="${CW/2}" ry="10"
               fill="none" stroke="${INK}" stroke-width="1.6" opacity="0" id="col-top-ell"/>
      <ellipse cx="${CX}" cy="${CY_BOT}" rx="${CW/2}" ry="10"
               fill="none" stroke="${INK}" stroke-width="1.6" opacity="0" id="col-bot-ell"/>
      ${trays}
      <line x1="${CX-CW/2}" y1="${FEED_Y}" x2="${CX-CW/2-24}" y2="${FEED_Y}"
            stroke="${C_FEED}" stroke-width="1.4" opacity="0" id="feed-nozzle"/>
      <text x="${CX+CW/2+22}" y="${CY_TOP+CH/2-2}" font-family="'DM Mono',monospace"
            font-size="14" fill="rgba(232,237,245,0.80)" text-anchor="start" opacity="0" id="lbl-stages">N = ${stages} theoretical</text>
      <text x="${CX+CW/2+22}" y="${CY_TOP+CH/2+14}" font-family="'DM Mono',monospace"
            font-size="14" fill="rgba(232,237,245,0.80)" text-anchor="start" opacity="0" id="lbl-stages2">stages</text>
      <text x="${CX+CW/2+22}" y="${CY_TOP+CH/2+30}" font-family="'DM Mono',monospace"
            font-size="11" fill="rgba(79,163,224,0.85)" text-anchor="start" opacity="0" id="lbl-stages3"
            onclick="event.stopPropagation();showParamInfo('stages')"
            style="cursor:pointer;text-decoration:underline">ⓘ what does this mean?</text>
    </g>

    <!-- REBOILER -->
    <g class="comp-g" onclick="selectComp('reboiler')">
      <rect class="hl" x="312" y="642" width="261" height="96" rx="4"
            fill="rgba(224,138,60,0.07)" stroke="${C_REB}" stroke-width="2.4" opacity="0"/>
      <rect id="reb-box" x="315" y="645" width="255" height="90" rx="2"
            fill="rgba(224,138,60,0.04)" stroke="${C_REB}" stroke-width="1.6"
            stroke-dasharray="${PERIM.reb}" stroke-dashoffset="${PERIM.reb}"/>
      ${rebHatch}
      <path d="M 345 730 Q 352 720 359 730 T 373 730" fill="none" stroke="${C_REB}" stroke-width="1.1" opacity="0" class="heat-wave"/>
      <path d="M 400 730 Q 407 720 414 730 T 428 730" fill="none" stroke="${C_REB}" stroke-width="1.1" opacity="0" class="heat-wave"/>
      <path d="M 455 730 Q 462 720 469 730 T 483 730" fill="none" stroke="${C_REB}" stroke-width="1.1" opacity="0" class="heat-wave"/>
      <text id="lbl-reboiler" x="443" y="696" font-family="'DM Mono',monospace" font-size="19"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" letter-spacing="0.12em" font-weight="500" opacity="0">REBOILER</text>
      <line x1="443" y1="645" x2="443" y2="623" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
      <line x1="443" y1="735" x2="443" y2="762" stroke="${INK}" stroke-width="1.1" opacity="0" class="nozzle"/>
      <line x1="570" y1="693" x2="700" y2="693" stroke="${C_STM}" stroke-width="1.2" opacity="0" class="nozzle"/>
      <line x1="700" y1="748" x2="570" y2="748" stroke="${C_STM}" stroke-width="1.0" opacity="0" class="nozzle"/>
    </g>

    <!-- CW BOXES -->
    <g class="comp-g" onclick="selectComp('coolingWater')">
      <rect id="cw-sup-box" x="85" y="82" width="105" height="48" rx="2"
            fill="rgba(78,201,148,0.05)" stroke="${C_CW}" stroke-width="1.4"
            stroke-dasharray="${PERIM.cwS}" stroke-dashoffset="${PERIM.cwS}"/>
      <text x="137" y="101" font-family="'DM Mono',monospace" font-size="16"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" font-weight="500" opacity="0" class="cw-lbl">CW SUPPLY</text>
      <text x="137" y="115" font-family="'DM Mono',monospace" font-size="13"
            fill="rgba(232,237,245,0.55)" text-anchor="middle" opacity="0" id="svg-cw-in-temp" class="cw-lbl">${state.params.cwTempIn}°C</text>
      <rect id="cw-ret-box" x="85" y="147" width="105" height="48" rx="2"
            fill="rgba(78,201,148,0.04)" stroke="${C_CW}" stroke-width="1.4"
            stroke-dasharray="${PERIM.cwR}" stroke-dashoffset="${PERIM.cwR}"/>
      <text x="137" y="166" font-family="'DM Mono',monospace" font-size="16"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" font-weight="500" opacity="0" class="cw-lbl">CW RETURN</text>
      <text x="137" y="180" font-family="'DM Mono',monospace" font-size="13"
            fill="rgba(232,237,245,0.55)" text-anchor="middle" opacity="0" id="svg-cw-out-temp" class="cw-lbl">${state.params.cwTempOut}°C</text>
      <text x="137" y="148" font-family="'DM Mono',monospace" font-size="13"
            fill="rgba(232,237,245,0.55)" text-anchor="middle" id="svg-cw-flow">— kg/h</text>
    </g>

    <!-- STEAM BOXES -->
    <g class="comp-g" onclick="selectComp('steamSystem')">
      <rect id="stm-box" x="700" y="665" width="115" height="56" rx="2"
            fill="rgba(200,169,110,0.05)" stroke="${C_STM}" stroke-width="1.4"
            stroke-dasharray="${PERIM.stm}" stroke-dashoffset="${PERIM.stm}"/>
      <text x="757" y="686" font-family="'DM Mono',monospace" font-size="18"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" font-weight="500" opacity="0" class="stm-lbl">STEAM IN</text>
      <text x="757" y="703" font-family="'DM Mono',monospace" font-size="12"
            fill="rgba(232,237,245,0.55)" text-anchor="middle" opacity="0" id="svg-stm-temp" class="stm-lbl">${state.params.steamTemp}°C · ${state.params.steamPressure} bar</text>
      <rect id="cnd-ret-box" x="700" y="720" width="115" height="56" rx="2"
            fill="rgba(200,169,110,0.03)" stroke="${C_STM}" stroke-width="1.2"
            stroke-dasharray="${PERIM.cnd2}" stroke-dashoffset="${PERIM.cnd2}"/>
      <text x="757" y="741" font-family="'DM Mono',monospace" font-size="18"
            fill="rgba(232,237,245,0.88)" text-anchor="middle" font-weight="500" opacity="0" class="stm-lbl">CONDENSATE</text>
      <text x="757" y="758" font-family="'DM Mono',monospace" font-size="12"
            fill="rgba(232,237,245,0.55)" text-anchor="middle" opacity="0" class="stm-lbl">RETURN</text>
      <text x="757" y="772" font-family="'DM Mono',monospace" font-size="13"
            fill="rgba(232,237,245,0.55)" text-anchor="middle" id="svg-condensate-temp">—°C</text>
    </g>

    <!-- FEED PUMP -->
    <g class="comp-g" onclick="selectComp('feed')" id="feed-pump-g" opacity="0">
      <circle cx="140" cy="${FEED_Y}" r="24" fill="rgba(78,201,148,0.07)" stroke="${C_FEED}" stroke-width="1.5"/>
      <path d="M 128 ${FEED_Y-13} A 14 14 0 0 1 152 ${FEED_Y+9}" fill="none" stroke="${C_FEED}" stroke-width="1.1" opacity="0.65"/>
      <text x="140" y="${FEED_Y+5}" font-family="'DM Mono',monospace" font-size="27"
            fill="${C_FEED}" text-anchor="middle" font-weight="500">P</text>
      <line x1="60" y1="${FEED_Y}" x2="116" y2="${FEED_Y}" stroke="${C_FEED}" stroke-width="1.2" marker-end="url(#arr)"/>
      <line x1="164" y1="${FEED_Y}" x2="${CX-CW/2-24}" y2="${FEED_Y}" stroke="${C_FEED}" stroke-width="1.2" marker-end="url(#arr)"/>
    </g>

    ${pipes} ${motionPaths} ${particles} ${labels}
  </svg>`;
}

// ── UPDATE SVG LABELS ─────────────────────────────────────────────────────
function updateSVGLabels() {
  const res = calc();
  const set = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
  set('svg-sub-distillate', res.err ? '—' : res.D  + ' kg/h');
  set('svg-sub-drum',       res.err ? '—' : 'L = ' + res.L + ' kg/h');
  set('svg-sub-drum-r',     res.Reff !== state.params.refluxRatio.toFixed(2)
    ? 'R = ' + res.Reff + ' (set ' + state.params.refluxRatio + ')'
    : 'R = ' + state.params.refluxRatio);
  set('svg-sub-column',     'α = ' + MIXES[state.mix].alpha);
  set('svg-sub-bottoms',    res.err ? '—' : res.B  + ' kg/h');
  set('svg-sub-steam',      res.err ? '—' : res.stFlow + ' kg/h');
  set('svg-sub-feed',       res.err ? '—' : 'F = ' + state.params.feedFlow + ' kg/h');
  set('svg-sub-feed-xf',    'xF = ' + state.params.feedComposition);
  set('svg-sub-reboiler',   res.err ? '—' : res.Qr + ' kW');
  set('svg-sub-condenser',  res.err ? '—' : res.Qc + ' kW');
  set('lbl-stages',  res.err ? 'N = — theoretical'  : 'N = ' + res.N + ' theoretical');
  set('lbl-stages2', res.err ? ''                     : '→ ' + res.Na + ' trays  (η = 70%)');
  set('svg-cw-in-temp',  state.params.cwTempIn  + '°C');
  set('svg-cw-out-temp', state.params.cwTempOut + '°C');
  set('svg-stm-temp',    state.params.steamTemp + '°C · ' + state.params.steamPressure + ' bar');
  set('svg-cw-flow',         res.err ? '—' : res.cwFlow + ' kg/h');
  set('svg-condensate-temp', res.err ? '—' : res.condT  + '°C');
}

// ── FLOW ANIMATION ────────────────────────────────────────────────────────
function startFlow() {
  const SA=state.flowAnims;
  function fp(sel,pathId,dur,staggerMs,op=0.88) {
    try {
      SA.push(animate(sel,{...createMotionPath(pathId),opacity:[0,op,op,0],duration:dur,delay:stagger(staggerMs),loop:true,ease:'linear'}));
    } catch(e){}
  }
  fp('.pv','#mp-vapor',2000,500,0.95);   fp('.plc','#mp-liq-col',2400,800,0.75);
  fp('.pcd','#mp-cnd-drum',1000,500);    fp('.prf','#mp-reflux',1400,700);
  fp('.pdi','#mp-distil',800,400);       fp('.pf','#mp-feed',1200,400);
  fp('.pld','#mp-liq-down',600,300,0.75);fp('.prv','#mp-reb-vap',700,230,0.95);
  fp('.pb','#mp-bottoms',1400,700);      fp('.pci','#mp-cw-in',900,450);
  fp('.pco','#mp-cw-out',900,450);       fp('.psi','#mp-steam',800,400);
  fp('.pso','#mp-cond',800,400);
  SA.push(animate('#cnd-box',{strokeWidth:[1.6,2.4,1.6],duration:2200,loop:true,ease:'inOutSine'}));
  SA.push(animate('#reb-box',{strokeWidth:[1.6,2.4,1.6],duration:1700,loop:true,ease:'inOutSine'}));
  SA.push(animate('#glow-bg-col',{opacity:[0.7,1.2,0.7],duration:1800,loop:true,ease:'inOutSine'}));
  SA.push(animate('#glow-bg-reb',{opacity:[0.6,1.1,0.6],duration:1400,loop:true,ease:'inOutSine'}));
}

function stopFlow() {
  state.flowAnims.forEach(a=>{try{a.pause();}catch(e){}});
  state.flowAnims=[];
  animate('.pv,.plc,.pcd,.prf,.pdi,.pf,.pld,.prv,.pb,.pci,.pco,.psi,.pso',{opacity:0,duration:400});
  animate('#cnd-box,#reb-box',{strokeWidth:1.6,duration:400});
}

// ── TOP BAR ───────────────────────────────────────────────────────────────
function buildTopBar() {
  document.getElementById('right-topbar').innerHTML = `
    <button class="flow-btn" id="btn-flow" onclick="toggleFlow()">Start Flow</button>
    <div id="error-area"></div>`;
}

function updateErrorBadge() {
  const res = calc();
  document.getElementById('error-area').innerHTML = res.err
    ? `<span class="err-badge">⚠ ${res.err}</span>` : '';
}

// ── RESULTS STRIP ─────────────────────────────────────────────────────────
function animateResults(initial=false) {
  const res=calc(), bar=document.getElementById('results-bar');
  if (!bar) return;
  const items = res.err ? [] : [
    {l:'Distillate', v:parseFloat(res.D),    u:'kg/h',  sub:res.m.light+'-rich',        clr:'#4FA3E0'},
    {l:'Bottoms',    v:parseFloat(res.B),    u:'kg/h',  sub:res.m.heavy+'-rich',         clr:'#E08A3C'},
    {l:'Reflux',     v:parseFloat(res.L),    u:'kg/h',  sub:'R = '+state.params.refluxRatio, clr:'#4FA3E0'},
    {l:'Calc. Stages',v:res.N,               u:'',dp:0,  sub:'Nmin = '+res.Nmin,           clr:'#8899AA'},
    {l:'Min Reflux', v:parseFloat(res.Rmin), u:'',      sub:'Underwood',                  clr:'#8899AA'},
    {l:'q-value',    v:parseFloat(res.q),    u:'',      sub:'Feed quality',                clr:'#4EC994'},
    {l:'Cond. Duty', v:parseFloat(res.Qc),   u:'kW',    sub:'Heat removal',                clr:'#4FA3E0'},
    {l:'Reb. Duty',  v:parseFloat(res.Qr),   u:'kW',    sub:'Heat input',                  clr:'#E08A3C'}
  ];
  bar.innerHTML = items.map(it=>`
    <div class="result-item">
      <div class="result-lbl">${it.l}</div>
      <div class="result-val" data-target="${it.v}"
           data-dp="${it.dp!==undefined?it.dp:(it.u===''?3:0)}"
           style="color:${it.clr}">—</div>
      <div class="result-sub">${it.u||it.sub}</div>
    </div>`).join('');
  bar.querySelectorAll('.result-val').forEach((el,i)=>{
    const it=items[i];
    const target=parseFloat(el.dataset.target), dp=parseInt(el.dataset.dp), c={v:0};
    if (!initial && state.prevVals[it.l]!==undefined && Math.abs(target-state.prevVals[it.l])>0.001) {
      animate(el, {scale:[1,1.18,1], duration:480, ease:spring({stiffness:320,damping:10})});
    }
    animate(c,{v:[0,target],duration:initial?900:500,delay:initial?stagger(65,{start:0})(i,items.length):0,
        ease:'outExpo',onUpdate:()=>{el.textContent=c.v.toFixed(dp);}});
  });
  items.forEach(it=>{state.prevVals[it.l]=it.v;});
}

// ── LEFT PANEL BUILDERS ───────────────────────────────────────────────────
function buildMasthead() {
  document.getElementById('lp-masthead').innerHTML = `
    <div class="lp-masthead">
      <div class="lp-title">Distillation Column</div>
      <div class="lp-tagline">Binary separation by vapour–liquid equilibrium</div>
      <select class="lp-mix-select" id="mixture-select" onchange="changeMixture(this.value)">
        ${Object.entries(MIXES).map(([k,m])=>
          `<option value="${k}" ${k===state.mix?'selected':''}>${m.name}  (α = ${m.alpha})</option>`
        ).join('')}
      </select>
    </div>`;
}

function buildIntro() {
  document.getElementById('lp-intro').innerHTML = `
    <div class="lp-section">
      <div class="lp-section-title">What is distillation?</div>
      <p class="lp-body">
        Distillation exploits differences in vapour pressure to separate a liquid mixture.
        The more volatile component concentrates in the rising vapour; the less volatile
        stays in the descending liquid. Repeated vapour–liquid contact across multiple
        equilibrium stages drives the separation toward the desired purity.
      </p>
      <svg viewBox="0 0 200 90" width="100%" style="margin-top:0.75rem;opacity:0.75">
        <rect x="80" y="5" width="40" height="80" rx="3"
              fill="none" stroke="rgba(26,22,18,0.20)" stroke-width="1.5"/>
        <line x1="82" y1="28" x2="118" y2="28" stroke="rgba(26,22,18,0.18)" stroke-width="1"/>
        <line x1="82" y1="52" x2="118" y2="52" stroke="rgba(26,22,18,0.18)" stroke-width="1"/>
        <line x1="100" y1="75" x2="100" y2="15" stroke="#1B6FAE" stroke-width="1.5"
              marker-end="url(#arr-concept)"/>
        <text x="120" y="20" font-family="Lora,serif" font-size="9" fill="#1B6FAE">Light (D)</text>
        <line x1="100" y1="20" x2="100" y2="80" stroke="#A05A14" stroke-width="1.5" opacity="0.5"/>
        <text x="120" y="82" font-family="Lora,serif" font-size="9" fill="#A05A14">Heavy (B)</text>
        <line x1="50" y1="50" x2="78" y2="50" stroke="#1A7A50" stroke-width="1.5"
              marker-end="url(#arr-concept)"/>
        <text x="14" y="53" font-family="Lora,serif" font-size="9" fill="#1A7A50">Feed</text>
        <defs>
          <marker id="arr-concept" markerWidth="5" markerHeight="5" refX="4" refY="2.5" orient="auto">
            <path d="M0,0 L5,2.5 L0,5 Z" fill="currentColor"/>
          </marker>
        </defs>
      </svg>
    </div>`;
}

const ANATOMY = [
  {key:'feed',         label:'Feed',            dot:'#1A7A50', compKey:'feed',
   desc:'Liquid or vapour mixture enters at the optimal tray based on its thermal condition (q-value).'},
  {key:'column',       label:'Column',           dot:'#3A4A5A', compKey:'column',
   desc:'Vertical vessel with multiple equilibrium stages. Liquid flows down; vapour rises through perforated trays.'},
  {key:'condenser',    label:'Condenser',        dot:'#1B6FAE', compKey:'condenser',
   desc:'Shell-and-tube heat exchanger. Cooling water condenses overhead vapour into liquid distillate.'},
  {key:'refluxDrum',   label:'Reflux Drum',      dot:'#6040A0', compKey:'refluxDrum',
   desc:'Accumulator splitting condensed liquid into distillate product and reflux returned to the column.'},
  {key:'reboiler',     label:'Reboiler',         dot:'#A05A14', compKey:'reboiler',
   desc:'Kettle reboiler at column base. Steam vaporises bottoms liquid to generate upward vapour flow.'},
  {key:'coolingWater', label:'Cooling Water',    dot:'#1A7A50', compKey:'coolingWater',
   desc:'Utility circuit supplying chilled water (25–30°C) to the condenser, returning at 40–50°C.'},
  {key:'steamSystem',  label:'Steam System',     dot:'#7A5A20', compKey:'steamSystem',
   desc:'LP/MP steam supplies latent heat to the reboiler. Condensate exits at saturation temperature.'},
];

function buildAnatomy() {
  document.getElementById('lp-anatomy').innerHTML = `
    <div class="lp-section">
      <div class="lp-section-title">Column anatomy</div>
      <div class="anatomy-list">
        ${ANATOMY.map((a,i)=>`
          <div class="anatomy-item" id="anatomy-${a.key}"
               onclick="scrollToAnatomy('${a.compKey}')">
            <span class="anatomy-dot" style="background:${a.dot}"></span>
            <div>
              <div class="anatomy-name">${a.label}</div>
              <div class="anatomy-desc">${a.desc}</div>
            </div>
          </div>`).join('')}
      </div>
    </div>`;
}

function scrollToAnatomy(compKey) {
  selectComp(compKey);
  const acc = document.getElementById('acc-' + compKey);
  if (acc && !acc.classList.contains('open')) toggleAccordion(compKey);
  const trigger = document.querySelector(`[data-acc="${compKey}"]`);
  if (trigger) trigger.scrollIntoView({behavior:'smooth', block:'nearest'});
}

function activateAnatomyItem(key) {
  document.querySelectorAll('.anatomy-item').forEach(el => el.classList.remove('active'));
  const match = ANATOMY.find(a => a.compKey === key);
  if (match) {
    const el = document.getElementById('anatomy-' + match.key);
    if (el) {
      el.classList.add('active');
      el.scrollIntoView({behavior:'smooth', block:'nearest'});
    }
  }
}

// ── KEY EQUATIONS ─────────────────────────────────────────────────────────
function buildEquations() {
  const eqs = [
    {label:'Overall balance',    latex:'F = D + B'},
    {label:'Component balance',  latex:'F x_F = D x_D + B x_B'},
    {label:'Reflux ratio',       latex:'R = \\frac{L}{D},\\quad V = L + D'},
    {label:'Minimum reflux (Underwood, q=1)',
     latex:'R_{min} = \\frac{1}{\\alpha-1}\\left(\\frac{x_D}{x_F} - \\alpha\\frac{1-x_D}{1-x_F}\\right)'},
  ];
  document.getElementById('lp-equations').innerHTML = `
    <div class="lp-section">
      <div class="lp-section-title">Key equations</div>
      ${eqs.map(eq=>`
        <div style="margin-bottom:0.55rem">
          <div style="font-family:'DM Mono',monospace;font-size:0.68rem;color:var(--lp-text3);
                      text-transform:uppercase;letter-spacing:0.07em;margin-bottom:0.2rem">
            ${eq.label}
          </div>
          <div class="eq-box">${rl(eq.latex)}</div>
        </div>`).join('')}
    </div>`;
}

// ── LIVE ANALYSIS CARD ────────────────────────────────────────────────────
function buildAnalysisCard() {
  document.getElementById('lp-analysis').innerHTML = `
    <div class="lp-section">
      <div class="lp-section-title">Live analysis</div>
      <div id="analysis-card"></div>
    </div>`;
}

function updateLiveAnalysis() {
  const card = document.getElementById('analysis-card');
  if (!card) return;
  const res = calc();

  if (res.err) {
    card.innerHTML = `<div class="analysis-err">⚠ ${res.err}</div>`;
    return;
  }

  const alpha = res.m.alpha;
  const R = state.params.refluxRatio;
  const Rmin = parseFloat(res.Rmin);
  const Rratio = (R / Rmin).toFixed(2);
  const q = parseFloat(res.q);

  const diffText = alpha >= 4.0
    ? `α = ${alpha} — <span class="analysis-val">easy separation</span>. Fewer stages needed.`
    : alpha >= 2.5
    ? `α = ${alpha} — <span class="analysis-val">moderate separation</span>. Standard column design.`
    : `α = ${alpha} — <span class="analysis-val">difficult separation</span>. Many stages; consider extractive distillation.`;

  const econStatus = parseFloat(Rratio) >= 1.2 && parseFloat(Rratio) <= 1.5
    ? '✓ within economic optimum (1.2–1.5×)'
    : parseFloat(Rratio) < 1.2
    ? '⚠ below economic optimum — approaching Rmin'
    : '↑ above optimum — higher energy cost';
  const ReffVal = parseFloat(res.Reff);
  const Rratio_eff = (ReffVal / Rmin).toFixed(2);
  const refluxText = `R<sub>set</sub> = ${R}, R<sub>eff</sub> = <span class="analysis-val">${res.Reff}</span> (${Rratio_eff}× R<sub>min</sub>). ${econStatus}.`;

  let qText;
  if (q > 1.05)      qText = `q = ${res.q} — <span class="analysis-val">subcooled liquid</span>. Extra reboiler duty required (V′ > V).`;
  else if (q > 0.95) qText = `q = ${res.q} — <span class="analysis-val">saturated liquid</span>. Reboiler matches condenser duty × 1.08.`;
  else if (q > 0.0)  qText = `q = ${res.q} — <span class="analysis-val">two-phase feed</span>. Mixed vapour–liquid entry.`;
  else               qText = `q = ${res.q} — <span class="analysis-val">superheated vapour</span>. Reduced reboiler duty (V′ &lt; V).`;

  const ratio = (parseFloat(res.Qr)/parseFloat(res.Qc)).toFixed(2);
  const energyText = `Qr/Qc = <span class="analysis-val">${ratio}</span>. Reboiler carries ${ratio > 1 ? 'more' : 'less'} duty than condenser — typical for ${q > 1 ? 'subcooled' : q < 1 ? 'superheated-vapour' : 'saturated'} feed.`;

  const Tcond_base = res.m.bpL * state.params.distillateComposition + res.m.bpH * (1 - state.params.distillateComposition);
  const overheadSuperheat = (parseFloat(res.Toverhead) - Tcond_base).toFixed(1);
  const superHeatKW = parseFloat(res.QcSensible);
  const implicitDR  = (parseFloat(res.Reff) - R).toFixed(2);
  const feedEffectText = q > 1.05
    ? `Cold feed (q = ${res.q}): column runs cooler, overhead arrives at dew point. No superheat term; R<sub>eff</sub> = R<sub>set</sub>. <span class="analysis-val">Qc unchanged</span> — extra duty falls entirely on reboiler.`
    : q >= 0.95
    ? `Saturated feed (q ≈ 1): baseline operation. R<sub>eff</sub> ≈ R<sub>set</sub>; negligible superheat.`
    : `Hot feed (q = ${res.q}): two mechanisms raise Qc. ① Column temperature profile shifts up — overhead vapour arrives <span class="analysis-val">superheated (+${overheadSuperheat}°C)</span>, adding ${superHeatKW} kW of sensible duty. ② Drum level control implicitly raises reflux: R<sub>eff</sub> = <span class="analysis-val">${res.Reff}</span> (+${implicitDR} above set-point), increasing V and base condensation load.`;

  card.innerHTML = `
    <div class="analysis-card">
      <div class="analysis-row">
        <span class="analysis-label">Difficulty</span>
        <span>${diffText}</span>
      </div>
      <div class="analysis-row">
        <span class="analysis-label">Reflux</span>
        <span>${refluxText}</span>
      </div>
      <div class="analysis-row">
        <span class="analysis-label">Feed</span>
        <span>${qText}</span>
      </div>
      <div class="analysis-row">
        <span class="analysis-label">Feed effect</span>
        <span>${feedEffectText}</span>
      </div>
      <div class="analysis-row">
        <span class="analysis-label">Energy</span>
        <span>${energyText}</span>
      </div>
    </div>`;
}

// ── PARAMETER CONTROLS ────────────────────────────────────────────────────
function buildParamsPanel() {
  const mix = MIXES[state.mix];
  const res = calc();

  const colSliders = [
    {k:'refluxRatio',     l:'Reflux Ratio (R)', p:'refluxRatio',
     min:1, max:10, step:0.1, d:state.params.refluxRatio, v:state.params.refluxRatio},
    {k:'feedComposition', l:'Feed Comp (xF)',   p:'feedComposition',
     min:0.1, max:0.9, step:0.05, d:state.params.feedComposition, v:state.params.feedComposition},
    {k:'distillatePurity',l:'Distillate (xD)',  p:'distillateComposition',
     min:0.9, max:0.999, step:0.005,
     d:(state.params.distillateComposition*100).toFixed(1)+'%', v:state.params.distillateComposition},
    {k:'bottomsPurity',   l:'Bottoms (xB)',     p:'bottomsComposition',
     min:0.001, max:0.10, step:0.005,
     d:(state.params.bottomsComposition*100).toFixed(1)+'%', v:state.params.bottomsComposition},
  ];
  const feedSliders = [
    {k:'feedFlow', l:'Feed Flow Rate',  p:'feedFlow',
     min:500, max:5000, step:100, d:state.params.feedFlow+' kg/h', v:state.params.feedFlow},
    {k:'feedTemp', l:'Feed Temperature',p:'feedTemp',
     min:mix.bpL-40, max:mix.bpH+40, step:1,
     d:state.params.feedTemp+'°C', v:state.params.feedTemp},
    {k:'feedPressure',l:'Pressure (atm)',p:'feedPressure',
     min:0.05, max:10, step:0.05, d:state.params.feedPressure+' atm', v:state.params.feedPressure},
  ];
  const utilSliders = [
    {k:'cwTempIn',    l:'CW Inlet',       p:'cwTempIn',
     min:15, max:35, step:1, d:state.params.cwTempIn+'°C', v:state.params.cwTempIn},
    {k:'cwTempOut',   l:'CW Outlet',      p:'cwTempOut',
     min:30, max:55, step:1, d:state.params.cwTempOut+'°C', v:state.params.cwTempOut},
    {k:'steamTemp',   l:'Steam Temp',     p:'steamTemp',
     min:120, max:300, step:5, d:state.params.steamTemp+'°C', v:state.params.steamTemp},
    {k:'steamPressure',l:'Steam Pressure',p:'steamPressure',
     min:1, max:20, step:0.5, d:state.params.steamPressure+' bar', v:state.params.steamPressure},
  ];

  const row = s => `
    <div class="param-row">
      <div class="param-top">
        <span class="param-label">${s.l}
          <button class="info-btn" onclick="showParamInfo('${s.k}')">i</button>
        </span>
        <span class="param-val" id="pval-${s.k}">${s.d}</span>
      </div>
      <input type="range" min="${s.min}" max="${s.max}" step="${s.step}" value="${s.v}"
             oninput="updateParam('${s.p}',this.value)">
    </div>`;

  document.getElementById('lp-params').innerHTML = `
    <div class="lp-section">
      <div class="lp-section-title">Parameters</div>
      ${res.err ? `<div class="analysis-err" style="margin-bottom:0.75rem">⚠ ${res.err}</div>` : ''}
      <div class="param-group-title">Column</div>
      ${colSliders.map(row).join('')}
      <div class="param-group-title">Feed</div>
      ${feedSliders.map(row).join('')}
      <div class="param-group-title">Utilities</div>
      ${utilSliders.map(row).join('')}
    </div>`;
}

// ── COMPONENT ACCORDIONS ──────────────────────────────────────────────────
const ACC_COLOURS = {
  condenser:    {dot:'#1B6FAE'},
  coolingWater: {dot:'#1A7A50'},
  refluxDrum:   {dot:'#6040A0'},
  reboiler:     {dot:'#A05A14'},
  steamSystem:  {dot:'#7A5A20'},
  feed:         {dot:'#1A7A50'},
  column:       {dot:'#3A4A5A'},
  tray:         {dot:'#3A4A5A'},
};

function buildAccordions() {
  const items = Object.entries(COMP_INFO).map(([k,c])=>`
    <div class="accordion-item">
      <button class="accordion-trigger" id="acc-trigger-${k}" data-acc="${k}"
              onclick="toggleAccordion('${k}');selectComp('${k}')">
        <span class="accordion-dot" style="background:${(ACC_COLOURS[k]||{dot:'#8899AA'}).dot}"></span>
        <span class="accordion-name">${c.name}</span>
        <span class="accordion-tag">${c.tag}</span>
        <span class="accordion-chevron">▾</span>
      </button>
      <div class="accordion-body" id="acc-${k}">
        <p class="accordion-fn">${c.fn}</p>
        ${c.eqs.map(eq=>`<div class="eq-box">${rl(eq)}</div>`).join('')}
        <div class="live-grid" id="acc-live-${k}"></div>
      </div>
    </div>`).join('');

  document.getElementById('lp-accordions').innerHTML = `
    <div style="border-top:1px solid var(--lp-border)">
      <div style="padding:0.75rem 1.5rem 0.35rem">
        <div class="lp-section-title">Component reference</div>
      </div>
      ${items}
    </div>`;
}

function toggleAccordion(key) {
  const body = document.getElementById('acc-' + key);
  const trigger = document.getElementById('acc-trigger-' + key);
  if (!body) return;
  const isOpen = body.classList.contains('open');
  document.querySelectorAll('.accordion-body').forEach(b => b.classList.remove('open'));
  document.querySelectorAll('.accordion-trigger').forEach(t => t.classList.remove('open'));
  if (!isOpen) {
    body.classList.add('open');
    trigger.classList.add('open');
    updateAccordionLive(key);
  }
}

function updateAccordionLive(key) {
  const res = calc();
  const grid = document.getElementById('acc-live-' + key);
  if (!grid || res.err) return;
  const map = {
    coolingWater: [{l:'CW Flow',v:res.cwFlow+' kg/h'},{l:'LMTD',v:res.condLMTD+'°C'},{l:'Area',v:res.condArea+' m²'},{l:'ΔT',v:res.cwDT+'°C'}],
    steamSystem:  [{l:'Steam Flow',v:res.stFlow+' kg/h'},{l:'LMTD',v:res.rebLMTD+'°C'},{l:'Area',v:res.rebArea+' m²'},{l:'Condensate',v:res.condT+'°C'}],
    condenser:    [{l:'Duty',v:res.Qc+' kW'},{l:'CW Flow',v:res.cwFlow+' kg/h'},{l:'Area',v:res.condArea+' m²'},{l:'LMTD',v:res.condLMTD+'°C'}],
    reboiler:     [{l:'Duty',v:res.Qr+' kW'},{l:'Steam',v:res.stFlow+' kg/h'},{l:'Area',v:res.rebArea+' m²'},{l:'LMTD',v:res.rebLMTD+'°C'}],
    refluxDrum:   [{l:'Distillate',v:res.D+' kg/h'},{l:'Reflux L',v:res.L+' kg/h'},{l:'R_eff / Rmin',v:(parseFloat(res.Reff)/parseFloat(res.Rmin)).toFixed(2)+'×'},{l:'R_eff',v:res.Reff}],
    feed:         [{l:'Flow F',v:state.params.feedFlow+' kg/h'},{l:'xF',v:state.params.feedComposition},{l:'q',v:res.q},{l:'Feed T',v:state.params.feedTemp+'°C'}],
    column:       [{l:'N stages',v:res.N},{l:'Nmin',v:res.Nmin},{l:'Actual trays',v:res.Na},{l:'α',v:res.m.alpha}],
    tray:         [{l:'η Murphree',v:'70%'},{l:'N theoretical',v:res.N},{l:'Actual trays',v:res.Na}],
  };
  const d = map[key];
  if (!d) return;
  grid.innerHTML = d.map(x=>`
    <div class="live-cell">
      <div class="live-cell-k">${x.l}</div>
      <div class="live-cell-v">${x.v}</div>
    </div>`).join('');
}

// ── EVENT HANDLERS ────────────────────────────────────────────────────────
function toggleFlow() {
  state.showFlow = !state.showFlow;
  const btn = document.getElementById('btn-flow');
  animate(btn, {scale:[0.88,1], duration:600, ease:spring({stiffness:280,damping:12})});
  if (state.showFlow) {
    btn.textContent = 'Stop Flow';
    btn.classList.add('active');
    startFlow();
  } else {
    btn.textContent = 'Start Flow';
    btn.classList.remove('active');
    stopFlow();
  }
}

function selectComp(k) {
  state.selectedComp = k;
  if (k) activateAnatomyItem(k);
  else document.querySelectorAll('.anatomy-item').forEach(el => el.classList.remove('active'));
}

function changeMixture(val) {
  state.mix = val;
  const m = MIXES[val];
  state.params.feedTemp = m.T;
  state.params.feedPressure = m.P;
  state.params.feedComposition = m.feedComp;
  buildParamsPanel();
  updateAll();
}

function updateParam(param, value) {
  state.params[param] = parseFloat(value);
  updateAll();
  buildParamsPanel();
}

function updateAll() {
  updateSVGLabels();
  animateResults(false);
  updateLiveAnalysis();
  updateErrorBadge();
  const openBody = document.querySelector('.accordion-body.open');
  if (openBody) {
    const key = openBody.id.replace('acc-', '');
    updateAccordionLive(key);
  }
}

function showParamInfo(p) {
  state.showParamInfo = p;
  renderParamModal();
}

// ── MODAL CLOSE (animated) ────────────────────────────────────────────────
function closeModalAnimated() {
  const box = document.querySelector('#modal-container .modal-box');
  if (!box) { document.getElementById('modal-container').innerHTML = ''; return; }
  animate(box, {
    opacity:    [1, 0],
    translateY: [0, 20],
    scale:      [1, 0.96],
    duration:   260,
    ease:       'inBack'
  }).then(() => { document.getElementById('modal-container').innerHTML = ''; });
}

function renderParamModal() {
  const info=PARAM_INFO[state.showParamInfo]; if (!info) return;
  document.getElementById('modal-container').innerHTML=`
  <div class="modal-backdrop" onclick="state.showParamInfo=null;closeParamModal()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div><div class="modal-title">${info.title}</div><div class="modal-tag">Parameter Reference</div></div>
        <button class="modal-close" onclick="state.showParamInfo=null;closeParamModal()">✕</button>
      </div>
      <div class="modal-sec-lbl">Definition</div><p class="modal-text">${info.def}</p>
      <div class="modal-sec-lbl">Application</div><p class="modal-text">${info.app}</p>
      <div class="modal-sec-lbl">Significance</div><p class="modal-text">${info.sig}</p>
      <button class="got-it" onclick="state.showParamInfo=null;closeParamModal()">Got it</button>
    </div>
  </div>`;
  animate(document.querySelector('.modal-box'),{opacity:[0,1],translateY:[20,0],scale:[0.96,1],duration:360,ease:'outBack'});
}

// ── IDLE PULSE ────────────────────────────────────────────────────────────
function startIdlePulse() {
  state.pulseAnims.push(
    animate('#glow-bg-col', {opacity:[0.7,1.1,0.7], duration:4500, loop:true, ease:'inOutSine'}),
    animate('#glow-bg-reb', {opacity:[0.6,1.0,0.6], duration:3200, loop:true, ease:'inOutSine'}),
    animate('#drum-level',  {fillOpacity:[0.05,0.14,0.05], duration:5500, loop:true, ease:'inOutSine'}),
    animate('.heat-wave',   {translateY:[0,-5,0], opacity:[0.75,1,0.75], duration:1800, delay:stagger(220), loop:true, ease:'inOutSine'}),
    animate('.tray-line',   {opacity:[0.5,0.9,0.5], duration:4500, delay:stagger(90,{from:'center'}), loop:true, ease:'inOutSine'})
  );
}

// ── BOOT SEQUENCE ─────────────────────────────────────────────────────────
function runBoot() {
  animate('#app', {opacity:[0,1], duration:600, ease:'linear'});

  animate('.left-panel', {
    translateX: [-24, 0], opacity: [0, 1],
    duration: 700, ease: 'outExpo', delay: 100
  });

  animate('.lp-title, .lp-tagline, .lp-mix-select', {
    opacity: [0,1], translateY: [-8,0],
    duration: 500, ease: 'outExpo', delay: stagger(80, {start: 200})
  });

  animate('#lp-intro, #lp-anatomy, #lp-equations, #lp-analysis, #lp-params, #lp-accordions', {
    opacity: [0,1], translateY: [12,0],
    duration: 500, ease: 'outExpo', delay: stagger(60, {start: 400})
  });

  const tl = createTimeline({defaults:{ease:'outExpo'}});

  tl.add('#glow-bg-col', {opacity:[0,0.85], duration:1200, ease:'inOutSine'}, 800)
    .add('#glow-bg-reb', {opacity:[0,0.75], duration:1000, ease:'inOutSine'}, 1000)
    .add('#col-box',     {strokeDashoffset:[PERIM.col,0], duration:950}, 600)
    .add('#col-top-ell', {opacity:[0,1], duration:400}, 1460)
    .add('#col-bot-ell', {opacity:[0,1], duration:400}, 1510)
    .add('.tray-line', {
      opacity:[0,1], scaleX:[0,1], duration:200,
      delay:stagger(22,{from:'first'}), ease:'outCirc'
    }, 1360)
    .add('#cnd-box',       {strokeDashoffset:[PERIM.cnd,0], duration:700}, 1800)
    .add('#lbl-condenser', {opacity:[0,1], duration:350}, 2390)
    .add('#reb-box',       {strokeDashoffset:[PERIM.reb,0], duration:700, ease:'outBounce'}, 2000)
    .add('#lbl-reboiler',  {opacity:[0,1], duration:350}, 2590)
    .add('#drum-box',        {strokeDashoffset:[PERIM.drum,0], duration:600, ease:'outBack'}, 2200)
    .add('#lbl-drum',        {opacity:[0,1], duration:350}, 2690)
    .add('#drum-level',      {fillOpacity:[0,0.06], duration:700, ease:'inOutSine'}, 2710)
    .add('#drum-level-line', {opacity:[0,1], duration:350}, 2730)
    .add(['#cw-sup-box','#cw-ret-box'], {
      strokeDashoffset:[PERIM.cwS,0], duration:500, delay:stagger(160)
    }, 2360)
    .add('.cw-lbl', {opacity:[0,1], duration:300, delay:stagger(50)}, 2800)
    .add(['#stm-box','#cnd-ret-box'], {
      strokeDashoffset:[PERIM.stm,0], duration:500, delay:stagger(160)
    }, 2460)
    .add('.stm-lbl', {opacity:[0,1], duration:300, delay:stagger(50)}, 2900)
    .add('#feed-pump-g', {opacity:[0,1], scale:[0.6,1], duration:550, ease:'outBack'}, 2700)
    .add('#feed-nozzle', {opacity:[0,1], duration:300}, 3060)
    .add('.nozzle',    {opacity:[0,1], duration:250, delay:stagger(35)}, 3060)
    .add('.heat-wave', {opacity:[0,0.9], duration:400, delay:stagger(100)}, 3160)
    .add('#pipes-group', {opacity:[0,0.9], duration:700}, 3160)
    .add(['#lbl-stages','#lbl-stages2','#lbl-stages3'], {opacity:[0,1], duration:400, delay:stagger(80)}, 3260)
    .add('.leader-line', {
      opacity:[0,0.5], scaleX:[0,1], duration:400,
      delay:stagger(55,{from:'first'}), ease:'outExpo'
    }, 3360)
    .add('.svg-label', {
      opacity:[0,1], translateY:[8,0], duration:350,
      delay:stagger(45,{from:'first'}), ease:'outBack'
    }, 3660)
    .call(()=>animateResults(true), 3900);

  setTimeout(startIdlePulse, 5000);
}

// ── INITIALISATION ────────────────────────────────────────────────────────
buildMasthead();
buildIntro();
buildAnatomy();
buildEquations();
buildAnalysisCard();
buildParamsPanel();
buildAccordions();
buildTopBar();

document.getElementById('svg-container').innerHTML = buildSVG();

updateSVGLabels();
animateResults(false);
updateLiveAnalysis();
updateErrorBadge();

runBoot();
</script>
</body>
</html>
